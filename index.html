<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>BG Broker — Mini App (export/import + remember admin)</title>
<link rel="icon" href="data:,">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --bg:#0f1115; --card:#151923; --text:#e8eaf0; --muted:#9aa3b2; --accent:#3ecf8e;
    --border:#202636; --input:#0f1320; --radius:14px; --radius-sm:10px;
    --s1:6px; --s2:10px; --s3:14px; --s4:18px; --s5:24px;
    --fs-12:12px; --fs-13:13px; --fs-14:14px; --fs-15:15px; --fs-16:16px; --fs-18:18px; --fs-20:20px;
    --container:960px;
  }
  @media (min-width:768px){ :root{ --fs-15:16px; --fs-18:20px; --fs-20:22px; } }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:var(--fs-15)/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;padding-bottom:env(safe-area-inset-bottom)}
  .wrap{max-width:var(--container);margin:0 auto;padding:0 var(--s3)}
  header{padding:calc(var(--s3) + env(safe-area-inset-top)) var(--s3) var(--s3);border-bottom:1px solid var(--border)}
  h1{margin:0 0 var(--s1);font-size:var(--fs-18);color:var(--accent)}
  .muted{color:var(--muted);font-size:var(--fs-13)}
  .tabs{display:flex;gap:var(--s1);margin:var(--s2) 0;flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);background:#1a2030;cursor:pointer;user-select:none}
  .tab.active{background:var(--accent);color:#08120e;border-color:transparent}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:var(--s3);margin:var(--s2) 0}
  label{display:block;margin:var(--s2) 0 var(--s1);font-weight:600}
  input,button{font:inherit}
  input{width:100%;padding:12px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--input);color:var(--text)}
  input::placeholder{color:#7f8797}
  .btn{display:inline-block;background:var(--accent);color:#08120e;border:0;border-radius:var(--radius-sm);padding:12px 16px;font-weight:700;cursor:pointer;min-width:44px;min-height:44px}
  .btn:active{transform:translateY(1px)}
  .btn.gray{background:#5f6674;color:#fff}
  .note{font-size:var(--fs-12);color:var(--muted)}
  .list .item{padding:12px;border:1px solid var(--border);border-radius:var(--radius-sm);margin:var(--s1) 0;background:var(--input)}
  .good{color:#3ecf8e}
  .row{display:grid;grid-template-columns:1fr;gap:var(--s2)}
  @media (min-width:768px){ .row{grid-template-columns:1fr 1fr} }
  @media (max-width:480px){ h1{font-size:var(--fs-16)} .btn{width:100%} }
  @media (prefers-color-scheme:light){
    :root{ --bg:#f7f8fb; --card:#fff; --text:#0c0d10; --muted:#5f6674; --border:#e6e8ee; --input:#fff }
    .tab{background:#f1f3f8}.tab.active{color:#fff}
  }
  /* Модалка пароля */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:10}
  .modal .box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;max-width:360px;width:calc(100% - 32px)}
  .modal .box h3{margin:0 0 8px}
  .inline{display:flex;align-items:center;gap:8px;margin-top:8px}
</style>
</head>
<body>
<header class="wrap">
  <h1>BG Broker — мини-аппа</h1>
  <div class="muted">Вставьте ссылку на закупку → прогноз участников/победителя. История загружается во вкладке «Админ».</div>
</header>

<main class="wrap" style="padding-bottom:calc(var(--s4) + env(safe-area-inset-bottom))">
  <div class="tabs" role="tablist" aria-label="Навигация">
    <button class="tab active" data-tab="predict" role="tab" aria-selected="true">Закупка</button>
    <button class="tab" data-tab="browse" role="tab" aria-selected="false">Все закупки</button>
    <button class="tab" data-tab="admin" role="tab" aria-selected="false">Админ</button>
  </div>

  <!-- Закупка -->
  <section class="card" id="predict" role="tabpanel">
    <label>Ссылка на закупку (ЕИС 44-ФЗ / 223-ФЗ)</label>
    <input id="tenderUrl" placeholder="https://zakupki.gov.ru/..." inputmode="url" />
    <div style="margin-top:var(--s2);display:flex;gap:var(--s2);flex-wrap:wrap">
      <button class="btn" id="analyze">Анализ</button>
      <span class="note">Контекст подтянем из ЕИС API позже; сейчас — частоты побед по закону и общий рейтинг.</span>
    </div>
    <div id="outPredict" class="list" aria-live="polite" style="margin-top:var(--s2)"></div>
  </section>

  <!-- Все закупки -->
  <section class="card" id="browse" style="display:none" role="tabpanel">
    <div class="row">
      <div><label>Фильтр по рег. номеру</label><input id="fltReg" placeholder="Напр.: 0818500000825..." /></div>
      <div><label>Фильтр по закону</label><input id="fltLaw" placeholder="44-ФЗ или 223-ФЗ" /></div>
    </div>
    <button class="btn" id="browseBtn" style="margin-top:var(--s2)">Показать закупки с победителями</button>
    <div class="note" style="margin-top:var(--s1)">Источник — загруженный CSV (7 колонок). У каждой компании выводим ИНН, почту, ФИО и телефон ЛПРа.</div>
    <div id="outBrowse" class="list" aria-live="polite" style="margin-top:var(--s2)"></div>
  </section>

  <!-- Админ -->
  <section class="card" id="admin" style="display:none" role="tabpanel">
    <h3 style="margin-top:0">Загрузка истории и обучение</h3>

    <div class="row">
      <div>
        <label>Загрузить историю (CSV, 7 колонок по порядку)</label>
        <input type="file" id="csv" accept=".csv" />
        <div class="note">1) company · 2) inn · 3) reg_number · 4) law · 5) winner_email · 6) dmr_name · 7) dmr_phone</div>
      </div>
      <div>
        <label>Статус модели</label>
        <div id="modelInfo" class="list"><div class="item">Исторических записей: 0<br>Версия модели: —</div></div>
      </div>
    </div>

    <div style="margin-top:var(--s2);display:flex;gap:var(--s2);flex-wrap:wrap">
      <button class="btn" id="loadDemo">Загрузить демо-данные</button>
      <button class="btn" id="train">Переобучить</button>
      <button class="btn gray" id="clear">Очистить историю</button>
    </div>

    <h3 style="margin-top:var(--s4)">Перенос между устройствами (без облака)</h3>
    <div class="row">
      <div>
        <label>Экспорт модели и данных</label>
        <button class="btn" id="exportBtn">Скачать bg-model.json</button>
        <div class="note">Сохраните файл, а на другом устройстве используйте «Импорт».</div>
      </div>
      <div>
        <label>Импорт модели и данных</label>
        <input type="file" id="importFile" accept=".json" />
        <div class="note">Выберите ранее сохранённый файл <code>bg-model.json</code>.</div>
      </div>
    </div>

    <div class="note" style="margin-top:var(--s2)">Модель хранится локально в браузере. Экспорт/импорт позволяет перенести её на другое устройство без использования облака.</div>
  </section>
</main>

<!-- Модалка пароля -->
<div class="modal" id="pwdModal" aria-hidden="true">
  <div class="box">
    <h3>Доступ к разделу «Админ»</h3>
    <div class="note" style="margin-bottom:8px">Введите пароль, чтобы открыть админ-панель.</div>
    <input id="pwdInput" type="password" placeholder="Пароль" />
    <label class="inline"><input type="checkbox" id="pwdRemember"> Запомнить пароль на этом устройстве</label>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn" id="pwdOk">Войти</button>
      <button class="btn gray" id="pwdCancel">Отмена</button>
    </div>
  </div>
</div>

<script>
try{ Telegram.WebApp.ready(); Telegram.WebApp.expand(); }catch(e){}

/* ===== Ключи хранилища ===== */
const LS_KEY   = 'bg_miniapp_store_v1';
const LS_ADMIN = 'bg_admin_persist';     // «запомнить пароль»
const SS_ADMIN = 'bg_admin_unlocked';    // доступ на сессию

/* ===== Состояние ===== */
const store = { rows: [], model: null, version: null };

/* ===== Утилиты ===== */
function extractRegNumber(url){ try{ const u=new URL(url); return u.searchParams.get('regNumber')||'' }catch(e){ return '' } }
function guessLawFromUrl(url){
  const s=url.toLowerCase();
  if(s.includes('44-фз')||s.includes('44fz')||s.includes('law44')) return '44-ФЗ';
  if(s.includes('223-фз')||s.includes('223fz')||s.includes('law223')) return '223-ФЗ';
  return '';
}
function clean(s){ return (s??'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').replace(/\uFFFD/g,'').trim(); }
function escapeHTML(s){ return clean(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* ===== Persist (локально) ===== */
function saveToLocal(){
  localStorage.setItem(LS_KEY, JSON.stringify({ rows: store.rows, model: store.model, version: store.version }));
}
function loadFromLocal(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return false;
  try{
    const data = JSON.parse(raw);
    if(data && Array.isArray(data.rows)){
      store.rows = data.rows; store.model = data.model || null; store.version = data.version || null;
      return true;
    }
  }catch(e){}
  return false;
}

/* ===== Чтение CSV (UTF-8/CP1251) ===== */
async function readFileSmart(file){
  const buf = await file.arrayBuffer();
  let text = new TextDecoder('utf-8',{fatal:false}).decode(new Uint8Array(buf));
  const bad=(text.match(/\uFFFD/g)||[]).length, cyr=(text.match(/[А-Яа-яЁё]/g)||[]).length;
  if(bad>0 || cyr===0){
    try{ text = new TextDecoder('windows-1251',{fatal:false}).decode(new Uint8Array(buf)); }catch(e){}
  }
  return text;
}
function parseCSVFlexible(text){
  const res = Papa.parse(text,{ delimiter:"", newline:"", quoteChar:'"', escapeChar:'"', header:false, skipEmptyLines:"greedy",
    transform: (val)=> (val==null?"":String(val)) });
  const rows=[];
  for(const r of res.data){
    if(!r || !r.length) continue;
    while(r.length<7) r.push('');
    const rec = {
      company      : clean(r[0]),
      inn          : clean(r[1]),
      reg_number   : clean(r[2]),
      law          : clean(r[3]).toUpperCase(),
      winner_email : clean(r[4]),
      dmr_name     : clean(r[5]),
      dmr_phone    : clean(r[6]),
    };
    const headerHints = ["company","inn","reg_number","law","winner_email","dmr_name","dmr_phone"];
    const maybeHeader = headerHints.some(h => rec.company.toLowerCase().includes(h) || rec.inn.toLowerCase().includes(h));
    if(maybeHeader) continue;
    if(!rec.company) continue;
    rows.push(rec);
  }
  return rows;
}

/* ===== Модель (частоты побед) ===== */
function trainModel(rows){
  const bySupplier={}, byLawSupplier={};
  rows.forEach(r=>{
    const c=r.company; if(!c) return;
    bySupplier[c]=bySupplier[c]||{wins:0, inn:r.inn, email:r.winner_email, dmr:r.dmr_name, phone:r.dmr_phone};
    bySupplier[c].wins++;
    if(r.law){ const key=r.law+'|'+c; byLawSupplier[key]=(byLawSupplier[key]||0)+1; }
  });
  return {bySupplier,byLawSupplier};
}
function updateModelInfo(){
  const n=store.rows.length, v=store.version||'—';
  document.getElementById('modelInfo').innerHTML=`<div class="item">Исторических записей: <b>${n}</b><br>Версия модели: <b>${v}</b></div>`;
}

/* ===== Bootstrap ===== */
(function bootstrap(){
  const ok = loadFromLocal();
  updateModelInfo();
  // авто-разблокировка админки, если «запомнить пароль» включали
  if(localStorage.getItem(LS_ADMIN)==='1'){
    sessionStorage.setItem(SS_ADMIN,'1');
  }
})();

/* ===== Админ: загрузка/обучение/очистка ===== */
document.getElementById('csv').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const text = await readFileSmart(f);
  const parsed = parseCSVFlexible(text);
  if(!parsed.length){ alert('Не удалось распознать CSV. Проверь разделитель и порядок 7 колонок.'); return; }
  store.rows = parsed;
  store.model = trainModel(parsed);
  store.version = 'csv-'+Date.now();
  saveToLocal(); updateModelInfo();
  alert('CSV загружен: '+store.rows.length+' записей. Модель обучена и сохранена.');
});
document.getElementById('loadDemo').onclick=()=>{
  const demo = [
    'ООО "СтройКрафт",7734567890,0818500000825001001,44-ФЗ,info@stroikraft.ru,Иванов И.И.,+7 900 000-00-01',
    'ООО "ТеплоСервис",7711111111,0818500000825002002,44-ФЗ,hello@teplo.ru,Петров П.П.,+7 900 000-00-02',
    'ООО "ИнжСтрой",7722222222,0818500000825003003,223-ФЗ,mail@inz.ru,Сидоров С.С.,+7 900 000-00-03',
    'ООО "ЭнергоПроект",7700000000,0818500000825004004,44-ФЗ,office@energo.pro,Кузнецов К.К.,+7 900 000-00-04',
    'ООО "ГидроМонтаж",7733333333,0818500000825005005,223-ФЗ,contact@hydro.ru,Смирнов С.С.,+7 900 000-00-05',
    'ООО "СтройКрафт",7734567890,0818500000825006006,44-ФЗ,info@stroikraft.ru,Иванов И.И.,+7 900 000-00-01'
  ].join('\n');
  store.rows = parseCSVFlexible(demo);
  store.model = trainModel(store.rows);
  store.version='demo-1';
  saveToLocal(); updateModelInfo();
  alert('Демо-данные загружены. Модель обучена и сохранена.');
};
document.getElementById('train').onclick=()=>{
  if(!store.rows.length){ alert('Сначала загрузите CSV.'); return; }
  store.model=trainModel(store.rows);
  store.version='retrain-'+Date.now();
  saveToLocal(); updateModelInfo();
  alert('Переобучение завершено. Модель сохранена.');
};
document.getElementById('clear').onclick=()=>{
  store.rows=[]; store.model=null; store.version=null;
  localStorage.removeItem(LS_KEY);
  updateModelInfo();
  alert('История и модель очищены (локально).');
};

/* ===== Экспорт / Импорт ===== */
function downloadJSON(filename, data){
  const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
  URL.revokeObjectURL(url);
}
document.getElementById('exportBtn').onclick = ()=>{
  if(!store.model || !store.rows.length){ alert('Нет данных для экспорта.'); return; }
  downloadJSON('bg-model.json', { rows: store.rows, model: store.model, version: store.version });
};
document.getElementById('importFile').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const text = await f.text();
    const data = JSON.parse(text);
    if(!Array.isArray(data.rows) || !data.model){ alert('Файл не содержит нужных данных.'); return; }
    store.rows = data.rows; store.model = data.model; store.version = data.version || 'import';
    saveToLocal(); updateModelInfo();
    alert('Импорт завершён. Модель сохранена локально.');
  }catch(err){ alert('Ошибка чтения файла: '+err.message); }
});

/* ===== Вкладки + пароль ===== */
const modal = document.getElementById('pwdModal');
const pwdInput = document.getElementById('pwdInput');
const pwdRemember = document.getElementById('pwdRemember');
function openPwd(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); pwdInput.value=''; setTimeout(()=>pwdInput.focus(),50); }
function closePwd(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
document.getElementById('pwdCancel').onclick = closePwd;
document.getElementById('pwdOk').onclick = ()=>{
  if(pwdInput.value==='admin'){
    sessionStorage.setItem(SS_ADMIN,'1');
    if(pwdRemember.checked){ localStorage.setItem(LS_ADMIN,'1'); } else { localStorage.removeItem(LS_ADMIN); }
    closePwd(); switchTab('admin');
  }else{
    alert('Неверный пароль');
  }
};
pwdInput.addEventListener('keydown',e=>{ if(e.key==='Enter') document.getElementById('pwdOk').click(); });

function switchTab(id){
  document.querySelectorAll('.tab').forEach(x=>{
    x.classList.toggle('active', x.dataset.tab===id);
    x.setAttribute('aria-selected', x.dataset.tab===id ? 'true':'false');
  });
  ['predict','browse','admin'].forEach(sec=>{
    document.getElementById(sec).style.display = (sec===id)?'block':'none';
  });
}
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    const id=t.dataset.tab;
    if(id==='admin' && !sessionStorage.getItem(SS_ADMIN)){
      openPwd(); return;
    }
    switchTab(id);
  });
});

/* ===== Анализ закупки ===== */
document.getElementById('analyze').addEventListener('click', ()=>{
  const url=document.getElementById('tenderUrl').value.trim();
  if(!url){ alert('Вставьте ссылку на закупку.'); return; }
  if(!store.model || !store.rows.length){ alert('Нет данных. Загрузите CSV во вкладке «Админ».'); return; }

  const reg = extractRegNumber(url) || '—';
  const lawGuess = guessLawFromUrl(url);

  const items = Object.entries(store.model.bySupplier).map(([company,meta])=>{
    const winsLaw = lawGuess ? (store.model.byLawSupplier[(lawGuess+'|'+company)]||0) : 0;
    const score = lawGuess ? (winsLaw*2 + meta.wins*0.5) : meta.wins;
    return { company, inn:meta.inn||'—', email:meta.email||'—', dmr:meta.dmr||'—', phone:meta.phone||'—', wins:meta.wins, winsLaw, score };
  }).sort((a,b)=>b.score-a.score).slice(0,5);

  const out=document.getElementById('outPredict'); out.innerHTML='';
  const head=document.createElement('div');
  head.className='item';
  head.innerHTML=`<b>Закупка:</b> ${escapeHTML(reg)}<br><span class="muted">Закон (угадан по ссылке): <b>${escapeHTML(lawGuess||'—')}</b>. Источник прогноза — частоты побед из истории.</span>`;
  out.appendChild(head);

  if(!items.length){ out.innerHTML+='<div class="item">Недостаточно данных для прогноза.</div>'; return; }

  items.forEach((it,i)=>{
    const rank = i===0 ? '<b class="good">— прогноз победителя</b>' : '';
    const why  = lawGuess ? `Побед в ${lawGuess}: ${it.winsLaw}, всего побед: ${it.wins}` : `Всего побед: ${it.wins}`;
    const div  = document.createElement('div');
    div.className='item';
    div.innerHTML = `<b>${i+1}. ${escapeHTML(it.company)}</b> (ИНН: ${escapeHTML(it.inn)}) ${rank}<br>
      <span class="muted">${escapeHTML(why)}</span><br>
      <span class="note">Контакты: ${escapeHTML(it.email)} · ${escapeHTML(it.dmr)} · ${escapeHTML(it.phone)}</span>`;
    out.appendChild(div);
  });
});

/* ===== Все закупки ===== */
document.getElementById('browseBtn').addEventListener('click', ()=>{
  if(!store.rows.length){ alert('Сначала загрузите CSV во вкладке «Админ».'); return; }
  const fltReg = document.getElementById('fltReg').value.trim().toLowerCase();
  const fltLaw = document.getElementById('fltLaw').value.trim().toUpperCase();

  let data = store.rows.slice();
  if(fltReg) data = data.filter(r=> (r.reg_number||'').toLowerCase().includes(fltReg));
  if(fltLaw) data = data.filter(r=> (r.law||'').toUpperCase().includes(fltLaw));

  const out=document.getElementById('outBrowse'); out.innerHTML='';
  if(!data.length){ out.innerHTML='<div class="item">Ничего не найдено под фильтры.</div>'; return; }

  data.slice(0,150).forEach((r,i)=>{
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML = `<b>${i+1}. Закупка ${escapeHTML(r.reg_number||'—')} (${escapeHTML((r.law||'').toUpperCase()||'—')})</b><br>
      Победитель: <b>${escapeHTML(r.company||'—')}</b> (ИНН: ${escapeHTML(r.inn||'—')})<br>
      <span class="note">Контакты: ${escapeHTML(r.winner_email||'—')} · ${escapeHTML(r.dmr_name||'—')} · ${escapeHTML(r.dmr_phone||'—')}</span>`;
    out.appendChild(div);
  });
});
</script>
</body>
</html>
