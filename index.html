<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>BG Broker — Mini App (MVP)</title>
<link rel="icon" href="data:,">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* ====== Тема и базовые переменные ====== */
  :root{
    --bg:#0f1115; --card:#151923; --text:#e8eaf0; --muted:#9aa3b2; --accent:#3ecf8e;
    --border:#202636; --input:#0f1320; --radius:14px; --radius-sm:10px;
    --space-1:6px; --space-2:10px; --space-3:14px; --space-4:18px; --space-5:24px;
    --fs-12:12px; --fs-13:13px; --fs-14:14px; --fs-15:15px; --fs-16:16px; --fs-18:18px; --fs-20:20px;
    --container:960px;
  }
  @media (min-width: 768px){ :root{ --fs-15:16px; --fs-18:20px; --fs-20:22px; } }

  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font: var(--fs-15)/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    padding-bottom: env(safe-area-inset-bottom);
  }

  /* ====== Контейнер и шапка ====== */
  .wrap{max-width:var(--container);margin:0 auto;padding:0 var(--space-3)}
  header{padding:calc(var(--space-3) + env(safe-area-inset-top)) var(--space-3) var(--space-3);
    border-bottom:1px solid var(--border)}
  h1{margin:0 0 var(--space-1);font-size:var(--fs-18);color:var(--accent)}
  .muted{color:var(--muted);font-size:var(--fs-13)}

  /* ====== Вкладки ====== */
  .tabs{display:flex;gap:var(--space-1);margin:var(--space-2) 0;flex-wrap:wrap}
  .tab{
    padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);
    background:#1a2030;cursor:pointer;user-select:none
  }
  .tab.active{background:var(--accent);color:#08120e;border-color:transparent}

  /* ====== Карточки и формы ====== */
  .card{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
    padding:var(--space-3);margin:var(--space-2) 0
  }
  label{display:block;margin:var(--space-2) 0 var(--space-1);font-weight:600}
  input,button,select,textarea{font:inherit}
  input,select,textarea{
    width:100%;padding:12px;border:1px solid var(--border);border-radius:var(--radius-sm);
    background:var(--input);color:var(--text)
  }
  input::placeholder,textarea::placeholder{color:#7f8797}
  .btn{
    display:inline-block;background:var(--accent);color:#08120e;border:0;border-radius:var(--radius-sm);
    padding:12px 16px;font-weight:700;cursor:pointer;min-width:44px;min-height:44px
  }
  .btn:active{transform:translateY(1px)}
  .note{font-size:var(--fs-12);color:var(--muted)}

  /* ====== Списки ====== */
  .list .item{
    padding:12px;border:1px solid var(--border);border-radius:var(--radius-sm);
    margin:var(--space-1) 0;background:var(--input)
  }
  .good{color:#3ecf8e}.warn{color:#ffce57}.bad{color:#ff7b7b}

  /* ====== Сетки (адаптив) ====== */
  .row{display:grid;grid-template-columns:1fr;gap:var(--space-2)}
  @media (min-width: 768px){
    .row{grid-template-columns:1fr 1fr}
  }
  /* Кнопки справа в строке */
  .row-actions{display:flex;align-items:flex-end;gap:var(--space-2);justify-content:flex-end;flex-wrap:wrap}

  /* ====== Улучшения для маленьких экранов ====== */
  @media (max-width: 480px){
    header{padding-top:calc(10px + env(safe-area-inset-top))}
    h1{font-size:var(--fs-16)}
    .btn{width:100%}
  }

  /* ====== Предпочтения системы (если у юзера светлая тема) ====== */
  @media (prefers-color-scheme: light){
    :root{ --bg:#f7f8fb; --card:#ffffff; --text:#0c0d10; --muted:#5f6674; --border:#e6e8ee; --input:#ffffff; }
    .tab{background:#f1f3f8}
    .tab.active{color:#ffffff}
    input,select,textarea{background:#fff}
  }
</style>
</head>
<body>
<header class="wrap">
  <h1>BG Broker — мини-аппа (тест)</h1>
  <div class="muted">Ссылка на закупку → прогноз участников/победителя. «Все закупки» — обзор по заказчику.</div>
</header>

<main class="wrap" style="padding-bottom:calc(var(--space-4) + env(safe-area-inset-bottom))">
  <div class="tabs" role="tablist" aria-label="Навигация">
    <button class="tab active" data-tab="predict" role="tab" aria-selected="true">Закупка</button>
    <button class="tab" data-tab="browse" role="tab" aria-selected="false">Все закупки</button>
  </div>

  <!-- ВКЛАДКА 1 -->
  <section class="card" id="predict" role="tabpanel" aria-labelledby="Закупка">
    <label>Ссылка на закупку (ЕИС 44-ФЗ/223-ФЗ)</label>
    <input id="tenderUrl" placeholder="https://zakupki.gov.ru/..." inputmode="url" />

    <div class="row">
      <div>
        <label>Заказчик (если не вытянется из ссылки)</label>
        <input id="customer" placeholder='Напр.: МУП «Теплосети»' />
      </div>
      <div>
        <label>Код ОКПД2 / предмет</label>
        <input id="okpd" placeholder="Напр.: 42.21.22.130 (или «теплосети»)" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Регион</label>
        <input id="region" placeholder="Напр.: Чувашская Республика" />
      </div>
      <div>
        <label>НМЦК / масштаб</label>
        <input id="amount" placeholder="Напр.: 75 000 000" inputmode="numeric" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>История побед (CSV)</label>
        <input type="file" id="csv" accept=".csv" />
        <div class="note">Формат: supplier,customer,okpd,region,amount,date</div>
      </div>
      <div class="row-actions">
        <button class="btn" id="loadDemo">Загрузить демо-данные</button>
        <button class="btn" id="analyze">Анализ</button>
      </div>
    </div>

    <div id="outPredict" class="list" aria-live="polite"></div>
    <div class="note">Примечание: по 223-ФЗ поставщики часто скрыты — прогноз строится на косвенных признаках.</div>
  </section>

  <!-- ВКЛАДКА 2 -->
  <section class="card" id="browse" style="display:none" role="tabpanel" aria-labelledby="Все закупки">
    <label>Фильтр по заказчику</label>
    <input id="fltCustomer" placeholder="Начните вводить название заказчика" />
    <label>Фильтр по ОКПД2/предмету</label>
    <input id="fltOkpd" placeholder="Код или слово" />
    <button class="btn" id="browseBtn" style="margin-top:var(--space-2)">Показать победителей и участников</button>
    <div id="outBrowse" class="list" aria-live="polite"></div>
  </section>
</main>

<script>
/* Телеграм-инициализация */
try{ Telegram.WebApp.ready(); Telegram.WebApp.expand(); }catch(e){}

/* CSV-парсер (простой) */
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const headers = lines.shift().split(',').map(h=>h.trim());
  return lines.map(l=>{
    // простой split по запятой; для CSV со сложными кавычками нужна библиотека, но для MVP ок
    const cols = l.split(',').map(c=>c.trim());
    const obj = {}; headers.forEach((h,i)=>obj[h]=cols[i]||''); return obj;
  });
}

/* Демо-данные */
let rows = [];
const demo = `supplier,customer,okpd,region,amount,date
ООО "СтройКрафт",ГУП "Чувашгаз",42.21.22.130,Чувашская Республика,299809000,2023-09-15
ООО "ТеплоСервис",МУП "Теплосети Алатыря",42.21.22.130,Чувашская Республика,75467000,2025-05-01
ООО "ИнжСтрой",Администрация г. Алатырь,43.29.11.110,Чувашская Республика,56000000,2024-11-22
ООО "ЭнергоПроект",ГУП "Чувашгаз",42.21.22.130,Чувашская Республика,180000000,2024-04-02
ООО "ГидроМонтаж",Администрация г. Алатырь,42.21.22.130,Чувашская Республика,92000000,2023-07-09
`;

document.getElementById('loadDemo').onclick = ()=>{
  rows = parseCSV(demo);
  alert('Загружены демо-данные (5 записей)');
};

document.getElementById('csv').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const text = await f.text(); rows = parseCSV(text);
  alert('CSV загружен: '+rows.length+' записей');
});

/* Скоринг */
function scoreSupplier(s, ctx){
  let score = 0; let reasons=[];
  const sameCustomer = rows.filter(r=>r.supplier===s && r.customer===ctx.customer).length;
  if(sameCustomer>0){ score += 3; reasons.push(`Победы у этого заказчика (${sameCustomer})`); }
  const okpdHits = rows.filter(r=>r.supplier===s &&
    (r.okpd.includes(ctx.okpd) || ctx.okpd.includes(r.okpd) ||
     (ctx.okpd && r.okpd && ctx.okpd.split(' ')[0]===r.okpd.split(' ')[0]))).length;
  if(okpdHits>0){ score += 2; reasons.push(`Опыт по предмету/ОКПД2 (${okpdHits})`); }
  const sameRegion = rows.filter(r=>r.supplier===s && r.region===ctx.region).length;
  if(sameRegion>0){ score += 1; reasons.push(`Работают в регионе`); }
  const amounts = rows.filter(r=>r.supplier===s).map(r=>Number(r.amount||0)).filter(Boolean);
  if(amounts.length){
    const avg = amounts.reduce((a,b)=>a+b,0)/amounts.length;
    const amt = Number((ctx.amount||'').toString().replace(/\s/g,''))||0;
    if(amt && Math.abs(amt-avg)/avg <= 0.5){
      score += 1; reasons.push(`Сумма в типичном диапазоне (${Math.round(avg).toLocaleString('ru-RU')} ₽)`);
    }
  }
  return {score,reasons};
}

/* Анализ закупки */
function analyze(){
  const ctx = {
    url: document.getElementById('tenderUrl').value.trim(),
    customer: document.getElementById('customer').value.trim(),
    okpd: document.getElementById('okpd').value.trim(),
    region: document.getElementById('region').value.trim(),
    amount: document.getElementById('amount').value.trim()
  };
  if(!rows.length){ alert('Загрузите CSV или нажмите «Загрузить демо-данные».'); return; }
  const suppliers = [...new Set(rows.map(r=>r.supplier))];
  const scored = suppliers.map(s=>({supplier:s, ...scoreSupplier(s,ctx)}))
    .sort((a,b)=>b.score-a.score).slice(0,5);

  const out = document.getElementById('outPredict'); out.innerHTML='';
  if(!scored.length){ out.innerHTML = '<div class="item">Нет кандидатов — дополните историю побед (CSV).</div>'; return; }
  scored.forEach((it,i)=>{
    const why = it.reasons.length ? it.reasons.join('; ') : 'Косвенные признаки по истории побед и предмету.';
    const rank = i===0 ? '<b class="good">— прогноз победителя</b>' : '';
    const div = document.createElement('div');
    div.className='item';
    div.innerHTML = `<b>${i+1}. ${it.supplier}</b> ${rank}<br><span class="muted">${why}</span>`;
    out.appendChild(div);
  });
}
document.getElementById('analyze').onclick = analyze;

/* Браузер закупок */
function browse(){
  const c = document.getElementById('fltCustomer').value.trim().toLowerCase();
  const k = document.getElementById('fltOkpd').value.trim().toLowerCase();
  const out = document.getElementById('outBrowse'); out.innerHTML='';
  if(!rows.length){ out.innerHTML = '<div class="item">Загрузите демо-данные или CSV.</div>'; return; }
  const data = rows.filter(r=>
    (!c || (r.customer||'').toLowerCase().includes(c)) &&
    (!k || (r.okpd||'').toLowerCase().includes(k) || (r.subject||'').toLowerCase().includes(k))
  ).slice(0,50);
  if(!data.length){ out.innerHTML = '<div class="item">Ничего не найдено под фильтр.</div>'; return; }
  data.forEach((r,i)=>{
    const div = document.createElement('div');
    div.className='item';
    div.innerHTML = `<b>${i+1}. ${r.customer}</b> — победитель: <b>${r.supplier}</b><br>
    <span class="muted">ОКПД2: ${r.okpd||'—'} | Регион: ${r.region||'—'} | Сумма: ${Number(r.amount||0).toLocaleString('ru-RU')} ₽ | Дата: ${r.date||'—'}</span>`;
    out.appendChild(div);
  });
}
document.getElementById('browseBtn').onclick = browse;

/* Переключение вкладок для доступности и адаптива */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>{
      x.classList.remove('active'); x.setAttribute('aria-selected','false');
    });
    t.classList.add('active'); t.setAttribute('aria-selected','true');
    const isPredict = t.dataset.tab==='predict';
    document.getElementById('predict').style.display = isPredict?'block':'none';
    document.getElementById('browse').style.display = isPredict?'none':'block';
  });
});
</script>
</body>
</html>
