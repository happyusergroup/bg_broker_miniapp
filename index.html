<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>BG Broker ‚Äî –º–∏–Ω–∏-–∞–ø–ø–∞</title>
<link rel="icon" href="data:,">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --bg: #0b0f17;
    --bg2: #0e1320;
    --card: rgba(255,255,255,.06);
    --stroke: rgba(255,255,255,.10);
    --text: #eef1f7;
    --muted:#97a0b6;
    --accent:#66e0a3;
    --accent-2:#6ea8ff;
    --danger:#ff6b6b;
    --radius:18px; --r2:12px;
    --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    --pad:16px;
    --w:980px;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg: #eef2f7; --bg2:#e9eef6;
      --card:#ffffff;
      --stroke:#e4e8f0;
      --text:#0c1324;
      --muted:#5f6b86;
      --accent:#14a86c;
      --accent-2:#2d6bff;
      --shadow: 0 12px 24px rgba(10,30,60,.08);
    }
  }

  /* ==== –±–∞–∑–æ–≤–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞, fullscreen-safe ==== */
  html,body{height:100%; margin:0}
  body{
    color:var(--text);
    background:
      radial-gradient(1200px 800px at 10% -10%, #1d2540 0%, transparent 60%),
      radial-gradient(1000px 700px at 110% 0%, #163240 0%, transparent 55%),
      linear-gradient(180deg,var(--bg2),var(--bg));
    font: 15px/1.55 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    letter-spacing:.1px;
    min-height:100dvh; /* edge-to-edge, iOS */
    padding-top: max(env(safe-area-inset-top), 0px);
    padding-bottom: max(env(safe-area-inset-bottom), 0px);
  }

  .wrap{max-width:var(--w); margin:0 auto; padding:18px clamp(14px,3vw,22px)}
  header{
    position:sticky; top:0; z-index:3;
    backdrop-filter:saturate(140%) blur(10px);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02));
    border-bottom:1px solid var(--stroke);
  }
  .brand{display:flex;align-items:center;gap:10px}
  .logo{
    width:34px;height:34px;border-radius:10px;
    background: radial-gradient(120% 120% at 20% 20%, var(--accent) 0%, var(--accent-2) 90%);
    box-shadow: 0 8px 16px rgba(100,200,255,.18);
  }
  h1{margin:0;font-size:18px}
  .sub{color:var(--muted);font-size:13px;margin-top:2px}
  .tabs{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap}
  .tab{
    border:1px solid var(--stroke); border-radius:12px; padding:10px 14px;
    background:var(--card); cursor:pointer; user-select:none;
    box-shadow:var(--shadow); transition:transform .12s ease, background .2s ease;
  }
  .tab:hover{transform:translateY(-1px)}
  .tab.active{background:linear-gradient(180deg,rgba(102,224,163,.18),rgba(102,224,163,.10)); border-color:rgba(102,224,163,.45)}
  main{padding:18px 0 30px}
  .grid{display:grid; gap:16px}
  .card{
    background:var(--card);
    border:1px solid var(--stroke);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:18px;
  }
  label{display:block; margin:12px 0 6px; font-weight:700}
  input,textarea,select{
    width:100%; background:linear-gradient(0deg, rgba(255,255,255,.06), rgba(255,255,255,.1));
    border:1px solid var(--stroke);
    border-radius:12px; padding:12px 14px; color:var(--text);
    outline:none; box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
  }
  textarea{min-height:120px; resize:vertical}
  input::placeholder, textarea::placeholder{color:var(--muted)}
  .row{display:grid; gap:12px; grid-template-columns:1fr}
  @media (min-width: 820px){ .row{grid-template-columns:1fr 1fr} }

  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:12px 16px; border-radius:12px; border:0; cursor:pointer; font-weight:800;
    color:#07130b; background:linear-gradient(180deg,var(--accent),#3dd98f);
    box-shadow:0 12px 20px rgba(40,180,120,.25);
    transition: transform .12s ease, filter .15s ease;
    min-height:44px;
  }
  .btn:hover{transform:translateY(-1px)}
  .btn.secondary{background:linear-gradient(180deg,var(--accent-2),#3f7dff); color:#06112c; box-shadow:0 12px 20px rgba(70,120,255,.25)}
  .btn.ghost{background:transparent; color:var(--text); border:1px dashed var(--stroke)}
  .btn.danger{background:linear-gradient(180deg,#ff8787,#ff6b6b); color:#1a0c0c; box-shadow:0 12px 20px rgba(255,90,90,.25)}
  .muted{color:var(--muted)}
  .list .item{padding:12px;border:1px dashed var(--stroke);border-radius:12px;background:rgba(255,255,255,.04);margin:8px 0}
  .hint{font-size:12px;color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.05)}
  .drop{
    border:2px dashed var(--stroke); border-radius:14px; padding:18px; text-align:center; color:var(--muted);
    transition:border-color .2s ease, background .2s ease;
  }
  .drop.drag{border-color:var(--accent); background:rgba(102,224,163,.08)}
  footer{margin:26px 0 12px;text-align:center;color:var(--muted);font-size:12px}

  /* ==== Onboarding (–∫–∞–∫ —É Blum): –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π ==== */
  .ob{
    position:fixed; inset:0; z-index:9999;
    background: #000; color:#fff;
    display:none; flex-direction:column; justify-content:space-between; align-items:center;
    padding: max(env(safe-area-inset-top),16px) 16px max(env(safe-area-inset-bottom),16px);
    min-height:100dvh;
  }
  .ob.show{display:flex}
  .ob-canvas{flex:1; width:100%; display:flex; align-items:center; justify-content:center; position:relative}
  .ob-title{width:100%; max-width:720px; margin:0 auto; text-align:left; padding:0 8px 8px}
  .ob-title h2{font-size:34px; line-height:1.15; margin:0 0 6px}
  .ob-title p{margin:0; color:#b7b7b7; font-size:16px}
  .ob-btn{width:min(640px,92vw); height:54px; border-radius:14px; border:0; font-weight:800; background:#fff; color:#000; }
  .ob-progress{position:absolute; top:0; left:0; right:0; height:4px; display:flex; gap:6px; padding: 0 16px}
  .ob-bar{flex:1; border-radius:999px; background:#2a2a2a; overflow:hidden}
  .ob-bar>i{display:block; height:100%; width:0; background:#fff; border-radius:999px; transition:width .25s ease}
  .ob-emoji{font-size:110px; filter: drop-shadow(0 0 24px rgba(255,160,0,.45))}
  @media (min-width:600px){ .ob-title h2{font-size:40px} .ob-emoji{font-size:140px} }
</style>
</head>
<body>
  <!-- Onboarding fullscreen -->
  <div id="ob" class="ob" aria-hidden="true">
    <div class="ob-progress">
      <div class="ob-bar"><i id="obp1"></i></div>
      <div class="ob-bar"><i id="obp2"></i></div>
      <div class="ob-bar"><i id="obp3"></i></div>
    </div>
    <div class="ob-canvas">
      <div id="obSlide1" class="ob-slide" style="text-align:center">
        <div class="ob-emoji">üî•</div>
      </div>
      <div id="obSlide2" class="ob-slide" style="display:none;text-align:center">
        <div class="ob-emoji">üìà</div>
      </div>
      <div id="obSlide3" class="ob-slide" style="display:none;text-align:center">
        <div class="ob-emoji">ü§ñ</div>
      </div>
    </div>
    <div class="ob-title">
      <h2 id="obTitle">–ü–æ–∫—É–ø–∞–π –∏ –ø—Ä–æ–¥–∞–≤–∞–π‚Ä¶ —à—É—Ç–∫–∞ üôÇ</h2>
      <p id="obDesc">–≠—Ç–æ BG Broker ‚Äî –º–∏–Ω–∏-–∞–ø–ø–∞. –ü—Ä–æ–≥–Ω–æ–∑ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤/–ø–æ–±–µ–¥–∏—Ç–µ–ª—è, –∫–æ–Ω—Ç–∞–∫—Ç—ã –∫–æ–º–ø–∞–Ω–∏–π –∏ –±—ã—Å—Ç—Ä—ã–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π.</p>
    </div>
    <button id="obBtn" class="ob-btn">–î–∞–ª–µ–µ</button>
  </div>

  <!-- App header -->
  <header id="appHeader">
    <div class="wrap">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>BG Broker ‚Äî –º–∏–Ω–∏-–∞–ø–ø–∞</h1>
          <div class="sub">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É ‚Üí –ø—Ä–æ–≥–Ω–æ–∑ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤/–ø–æ–±–µ–¥–∏—Ç–µ–ª—è. –ò—Å—Ç–æ—Ä–∏—é –∑–∞–≥—Ä—É–∂–∞–µ–º –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–ê–¥–º–∏–Ω¬ª.</div>
        </div>
      </div>
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="predict" role="tab" aria-selected="true">–ó–∞–∫—É–ø–∫–∞</div>
        <div class="tab" data-tab="browse" role="tab" aria-selected="false">–í—Å–µ –∑–∞–∫—É–ø–∫–∏</div>
        <div class="tab" data-tab="admin" role="tab" aria-selected="false">–ê–¥–º–∏–Ω</div>
      </div>
    </div>
  </header>

  <!-- App main -->
  <main class="wrap">
    <div class="grid">
      <!-- –ó–∞–∫—É–ø–∫–∞ -->
      <section id="predict" class="card" role="tabpanel">
        <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–∫—É–ø–∫—É (–ï–ò–° 44-–§–ó / 223-–§–ó)</label>
        <input id="tenderUrl" placeholder="https://zakupki.gov.ru/..." inputmode="url"/>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <button class="btn" id="analyze">–ê–Ω–∞–ª–∏–∑</button>
          <button class="btn ghost" id="clearPred">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <div class="hint">–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ï–ò–° –ø–æ–¥–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ. –°–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–π—Ç–∏–Ω–≥ –ø–æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º –ø–æ–±–µ–¥–∞–º.</div>
        </div>
        <div id="outPredict" class="list" style="margin-top:12px" aria-live="polite"></div>
      </section>

      <!-- –í—Å–µ –∑–∞–∫—É–ø–∫–∏ -->
      <section id="browse" class="card" style="display:none" role="tabpanel">
        <div class="row">
          <div>
            <label>–§–∏–ª—å—Ç—Ä –ø–æ —Ä–µ–≥. –Ω–æ–º–µ—Ä—É</label>
            <input id="fltReg" placeholder="–ù–∞–ø—Ä.: 0818500000825..."/>
          </div>
          <div>
            <label>–§–∏–ª—å—Ç—Ä –ø–æ –∑–∞–∫–æ–Ω—É</label>
            <input id="fltLaw" placeholder="44-–§–ó –∏–ª–∏ 223-–§–ó"/>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn secondary" id="browseBtn">–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–∫—É–ø–∫–∏</button>
          <button class="btn ghost" id="clearBrowse">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
        </div>
        <div class="hint" style="margin-top:8px">–ò—Å—Ç–æ—á–Ω–∏–∫ ‚Äî –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π CSV (7 –∫–æ–ª–æ–Ω–æ–∫). –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ –≤—ã–≤–æ–¥–∏–º –ò–ù–ù, –ø–æ—á—Ç—É –∏ –õ–ü–†.</div>
        <div id="outBrowse" class="list" style="margin-top:12px" aria-live="polite"></div>
      </section>

      <!-- –ê–¥–º–∏–Ω -->
      <section id="admin" class="card" style="display:none" role="tabpanel">
        <h3 style="margin:0 0 6px">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏ –æ–±—É—á–µ–Ω–∏–µ</h3>

        <div class="row">
          <div>
            <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é (CSV, 7 –∫–æ–ª–æ–Ω–æ–∫ –ø–æ –ø–æ—Ä—è–¥–∫—É)</label>
            <input type="file" id="csv" accept=".csv,text/csv"/>
            <div class="drop" id="drop">–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ CSV —Å—é–¥–∞</div>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" id="loadDemo">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ</button>
              <button class="btn secondary" id="train">–ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å</button>
              <button class="btn danger" id="clear">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
            </div>
            <label style="margin-top:14px">–í—Å—Ç–∞–≤–∏—Ç—å CSV —Ç–µ–∫—Å—Ç–æ–º (–µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –Ω–∞ iPhone)</label>
            <textarea id="csvText" placeholder='company,inn,reg_number,law,winner_email,dmr_name,dmr_phone\n...'></textarea>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" id="parseText">–ò–º–ø–æ—Ä—Ç –∏–∑ —Ç–µ–∫—Å—Ç–∞</button>
              <button class="btn ghost" id="clearText">–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ</button>
            </div>
          </div>
          <div>
            <label>–°—Ç–∞—Ç—É—Å –º–æ–¥–µ–ª–∏</label>
            <div id="modelInfo" class="list">
              <div class="item">–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π: 0<br/>–í–µ—Ä—Å–∏—è –º–æ–¥–µ–ª–∏: ‚Äî</div>
            </div>

            <label style="margin-top:12px">–ü–µ—Ä–µ–Ω–æ—Å –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ (–±–µ–∑ –æ–±–ª–∞–∫–∞)</label>
            <div class="chips" style="margin-bottom:8px">
              <div class="chip">–≠–∫—Å–ø–æ—Ä—Ç JSON ‚Üí –Ω–∞ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</div>
              <div class="chip">–ò–º–ø–æ—Ä—Ç JSON ‚Üê –∏–∑ —Ñ–∞–π–ª–∞</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" id="exportBtn">–°–∫–∞—á–∞—Ç—å bg-model.json</button>
              <input type="file" id="importFile" accept=".json" style="max-width:260px"/>
            </div>

            <label style="margin-top:14px">–õ–æ–≥–∏</label>
            <div id="logs" class="list" style="min-height:80px">
              <div class="item muted">–ó–¥–µ—Å—å –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ —Å—Ç–∞—Ç—É—Å–µ.</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>BG Broker ¬∑ –±—ã—Å—Ç—Ä—ã–π –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑. –î–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è ‚Äî —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –±–∞–Ω–∫–∞ –∏ –ï–ò–° API.</footer>

  <!-- –ü–∞—Ä–æ–ª—å –∫ ¬´–ê–¥–º–∏–Ω¬ª -->
  <div id="pwdModal" class="modal" aria-hidden="true" style="display:none;align-items:center;justify-content:center;backdrop-filter: blur(6px) saturate(140%); background:rgba(0,0,0,.35)">
    <div class="box" style="width:min(92vw,420px); background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:18px; box-shadow:var(--shadow)">
      <h3 style="margin:0 0 6px">–î–æ—Å—Ç—É–ø –∫ —Ä–∞–∑–¥–µ–ª—É ¬´–ê–¥–º–∏–Ω¬ª</h3>
      <div class="muted" style="margin-bottom:8px">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å (–ø–æ–¥—Å–∫–∞–∑–∫–∞: <b>admin</b>)</div>
      <input id="pwdInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å"/>
      <label style="margin-top:8px"><input type="checkbox" id="pwdRemember"> –ó–∞–ø–æ–º–Ω–∏—Ç—å –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</label>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="pwdOk">–í–æ–π—Ç–∏</button>
        <button class="btn ghost" id="pwdCancel">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

<script>
/* ===== Telegram edge-to-edge ===== */
try {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
  Telegram.WebApp.setBackgroundColor('#000000'); // –ø–æ–¥ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
  Telegram.WebApp.setHeaderColor('secondary_bg_color');
} catch(e) {}

/* ===== Onboarding ===== */
const OB_SEEN_KEY = 'bg_ob_seen_v1';
const ob = document.getElementById('ob');
const appHeader = document.getElementById('appHeader');

function showOnboarding(){
  ob.classList.add('show');
  appHeader.style.visibility='hidden'; // –∫–∞–∫ –≤ Blum ‚Äî ¬´–ø–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º¬ª
  setProgress(1);
}
function hideOnboarding(){
  ob.classList.remove('show');
  appHeader.style.visibility='visible';
  try { Telegram.WebApp.setBackgroundColor(''); } catch(e){}
}
function setProgress(step){
  document.getElementById('obp1').style.width = step>=1 ? '100%' : '0';
  document.getElementById('obp2').style.width = step>=2 ? '100%' : '0';
  document.getElementById('obp3').style.width = step>=3 ? '100%' : '0';
}
(function initOB(){
  if(localStorage.getItem(OB_SEEN_KEY)==='1'){ hideOnboarding(); return; }
  showOnboarding();
  let step=1;
  const title = document.getElementById('obTitle');
  const desc  = document.getElementById('obDesc');
  const s1 = document.getElementById('obSlide1');
  const s2 = document.getElementById('obSlide2');
  const s3 = document.getElementById('obSlide3');
  const btn = document.getElementById('obBtn');

  function render(){
    s1.style.display = step===1?'block':'none';
    s2.style.display = step===2?'block':'none';
    s3.style.display = step===3?'block':'none';
    setProgress(step);
    if(step===1){ title.textContent='–ü—Ä–æ–≥–Ω–æ–∑ –ø–æ –∑–∞–∫—É–ø–∫–µ –∑–∞ 5 —Å–µ–∫—É–Ω–¥'; desc.textContent='–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –∏–∑ –ï–ò–° ‚Äî –ø–æ–ª—É—á–∞–π—Ç–µ —Ç–æ–ø –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–µ ¬´–ø–æ—á–µ–º—É¬ª.'; btn.textContent='–î–∞–ª–µ–µ'; }
    if(step===2){ title.textContent='–ö–æ–Ω—Ç–∞–∫—Ç—ã –∫–æ–º–ø–∞–Ω–∏–π ‚Äî –ª–µ–≥–∞–ª—å–Ω–æ'; desc.textContent='–¢—è–Ω–µ–º —Ç–æ–ª—å–∫–æ –ø—É–±–ª–∏—á–Ω—ã–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã (–ï–ì–†–Æ–õ, Rusprofile, —Å–∞–π—Ç—ã).'; btn.textContent='–î–∞–ª–µ–µ'; }
    if(step===3){ title.textContent='–ê–¥–º–∏–Ω–∫–∞ –∏ –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏'; desc.textContent='–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV —Å –∏—Å—Ç–æ—Ä–∏–µ–π ‚Äî –ø—Ä–æ–≥–Ω–æ–∑ —Å—Ç–∞–Ω–µ—Ç —Ç–æ—á–Ω–µ–µ. –ü–∞—Ä–æ–ª—å ¬´admin¬ª.'; btn.textContent='–ù–∞—á–∞—Ç—å'; }
  }
  btn.addEventListener('click',()=>{
    if(step<3){ step++; render(); }
    else { localStorage.setItem(OB_SEEN_KEY,'1'); hideOnboarding(); }
  });
  render();
})();

/* ===== Helpers & State (–∫–∞–∫ –≤ MVP Beta 1) ===== */
const IS_IOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const LS_KEY='bg_miniapp_store_v1', LS_ADMIN='bg_admin_persist', SS_ADMIN='bg_admin_unlocked';
const $ = (s)=>document.querySelector(s);
const log = (msg, type='info')=>{
  const box = $('#logs');
  const div = document.createElement('div');
  div.className = 'item';
  if(type==='err') div.style.borderColor = 'rgba(255,107,107,.5)';
  if(type==='ok')  div.style.borderColor = 'rgba(102,224,163,.5)';
  div.innerHTML = msg;
  box.prepend(div);
};

const store = { rows: [], model:null, version:null };

function clean(s){ return (s??'').toString().replace(/\u00A0/g,' ').replace(/\s+/g,' ').replace(/\uFFFD/g,'').trim() }
function escapeHTML(s){return clean(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]))}
function extractRegNumber(url){ try{ const u=new URL(url); return u.searchParams.get('regNumber')||'' }catch{ return '' } }
function guessLawFromUrl(url){ const s=url.toLowerCase(); if(s.includes('44-—Ñ–∑')||s.includes('44fz'))return'44-–§–ó'; if(s.includes('223-—Ñ–∑')||s.includes('223fz'))return'223-–§–ó'; return '' }

function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify({rows:store.rows, model:store.model, version:store.version})) }
function loadLocal(){
  try{
    const raw=localStorage.getItem(LS_KEY); if(!raw) return false;
    const dat=JSON.parse(raw);
    if(Array.isArray(dat.rows)){ store.rows=dat.rows; store.model=dat.model||null; store.version=dat.version||null; return true; }
  }catch{}
  return false;
}

function toRows(res){
  const rows=[];
  for(const r of res.data){
    if(!r || !r.length) continue;
    while(r.length<7) r.push('');
    const rec={
      company:clean(r[0]), inn:clean(r[1]), reg_number:clean(r[2]),
      law:clean(r[3]).toUpperCase(), winner_email:clean(r[4]),
      dmr_name:clean(r[5]), dmr_phone:clean(r[6]),
    };
    const headerHints=["company","inn","reg_number","law","winner_email","dmr_name","dmr_phone"];
    const maybeHeader=headerHints.some(h=>rec.company.toLowerCase().includes(h)||rec.inn.toLowerCase().includes(h));
    if(maybeHeader) continue;
    if(!rec.company) continue;
    rows.push(rec);
  }
  return rows;
}

function trainModel(rows){
  const bySupplier={}, byLawSupplier={};
  rows.forEach(r=>{
    const c=r.company; if(!c) return;
    bySupplier[c]=bySupplier[c]||{wins:0, inn:r.inn, email:r.winner_email, dmr:r.dmr_name, phone:r.dmr_phone};
    bySupplier[c].wins++;
    if(r.law){ const key=r.law+'|'+c; byLawSupplier[key]=(byLawSupplier[key]||0)+1; }
  });
  return {bySupplier, byLawSupplier};
}
function updateModelInfo(){
  $('#modelInfo').innerHTML=`<div class="item">–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π: <b>${store.rows.length}</b><br>–í–µ—Ä—Å–∏—è –º–æ–¥–µ–ª–∏: <b>${store.version||'‚Äî'}</b></div>`;
}

/* ===== Bootstrap ===== */
(function(){
  if(loadLocal()){ updateModelInfo(); log('–õ–æ–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'ok'); }
  if(localStorage.getItem(LS_ADMIN)==='1'){ sessionStorage.setItem(SS_ADMIN,'1'); }
})();

/* ===== Admin auth ===== */
const modal=$('#pwdModal'), pwd=$('#pwdInput'), remember=$('#pwdRemember');
function openPwd(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); setTimeout(()=>pwd.focus(),50) }
function closePwd(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true') }
$('#pwdCancel').onclick=closePwd;
$('#pwdOk').onclick=()=>{
  if(pwd.value==='admin'){
    sessionStorage.setItem(SS_ADMIN,'1');
    if(remember.checked) localStorage.setItem(LS_ADMIN,'1'); else localStorage.removeItem(LS_ADMIN);
    closePwd(); switchTab('admin');
  } else { log('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'err'); }
}
pwd.addEventListener('keydown',e=>{ if(e.key==='Enter') $('#pwdOk').click() });

/* ===== Tabs ===== */
function switchTab(id){
  document.querySelectorAll('.tab').forEach(t=>{
    t.classList.toggle('active', t.dataset.tab===id);
    t.setAttribute('aria-selected', t.dataset.tab===id ? 'true':'false');
  });
  ['predict','browse','admin'].forEach(sec=>{
    document.getElementById(sec).style.display=(sec===id)?'block':'none';
  });
}
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    const id=t.dataset.tab;
    if(id==='admin' && !sessionStorage.getItem(SS_ADMIN)) { openPwd(); return; }
    switchTab(id);
  }
});

/* ===== CSV import (iPhone-safe) ===== */
async function parseCsvText(text,{useWorker=true}={}){
  return new Promise((resolve,reject)=>{
    Papa.parse(text,{
      header:false, skipEmptyLines:"greedy",
      worker: useWorker,
      complete: r=>resolve(toRows(r)),
      error: e=>reject(e)
    });
  });
}
$('#csv').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const text = await f.text();
    const rows = await parseCsvText(text,{useWorker:!IS_IOS});
    if(!rows.length){ log('CSV —Ä–∞–∑–æ–±—Ä–∞–Ω, –Ω–æ –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∫–∞–∫ ¬´CSV UTF-8¬ª.', 'err'); return; }
    store.rows = rows; store.model = trainModel(rows); store.version='csv-'+Date.now();
    saveLocal(); updateModelInfo(); log(`CSV –∑–∞–≥—Ä—É–∂–µ–Ω: ${rows.length} –∑–∞–ø–∏—Å–µ–π.`, 'ok');
  }catch(err){ log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV: '+(err?.message||err), 'err'); }
});
$('#parseText').onclick = async ()=>{
  const text = $('#csvText').value.trim();
  if(!text){ log('–ü–æ–ª–µ —Å CSV –ø—É—Å—Ç–æ–µ.', 'err'); return; }
  try{
    const rows = await parseCsvText(text,{useWorker:false});
    if(!rows.length){ log('–¢–µ–∫—Å—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω, –Ω–æ –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏.', 'err'); return; }
    store.rows = rows; store.model = trainModel(rows); store.version='text-'+Date.now();
    saveLocal(); updateModelInfo(); log(`–ò–º–ø–æ—Ä—Ç –∏–∑ —Ç–µ–∫—Å—Ç–∞: ${rows.length} –∑–∞–ø–∏—Å–µ–π.`, 'ok');
  }catch(err){ log('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–µ–∫—Å—Ç–∞: '+(err?.message||err), 'err'); }
};
$('#clearText').onclick = ()=> $('#csvText').value = '';
const drop=$('#drop');
['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag') }));
['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag') }));
drop.addEventListener('drop', async e=>{
  const file = e.dataTransfer.files?.[0]; if(!file) return;
  $('#csv').files = e.dataTransfer.files;
  try{
    const text = await file.text();
    const rows = await parseCsvText(text,{useWorker:true});
    if(!rows.length){ log('CSV —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω, –Ω–æ –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç.', 'err'); return; }
    store.rows = rows; store.model = trainModel(rows); store.version='csv-'+Date.now();
    saveLocal(); updateModelInfo(); log(`CSV –∑–∞–≥—Ä—É–∂–µ–Ω (dnd): ${rows.length} –∑–∞–ø–∏—Å–µ–π.`, 'ok');
  }catch(err){ log('–û—à–∏–±–∫–∞ dnd: '+(err?.message||err), 'err'); }
});

/* ===== Demo, retrain, clear ===== */
$('#loadDemo').onclick=()=>{
  const demo=[
    '–û–û–û "–°—Ç—Ä–æ–π–ö—Ä–∞—Ñ—Ç",7734567890,0818500000825001001,44-–§–ó,info@stroikraft.ru,–ò–≤–∞–Ω–æ–≤ –ò.–ò.,+7 900 000-00-01',
    '–û–û–û "–¢–µ–ø–ª–æ–°–µ—Ä–≤–∏—Å",7711111111,0818500000825002002,44-–§–ó,hello@teplo.ru,–ü–µ—Ç—Ä–æ–≤ –ü.–ü.,+7 900 000-00-02',
    '–û–û–û "–ò–Ω–∂–°—Ç—Ä–æ–π",7722222222,0818500000825003003,223-–§–ó,mail@inz.ru,–°–∏–¥–æ—Ä–æ–≤ –°.–°.,+7 900 000-00-03',
    '–û–û–û "–≠–Ω–µ—Ä–≥–æ–ü—Ä–æ–µ–∫—Ç",7700000000,0818500000825004004,44-–§–ó,office@energo.pro,–ö—É–∑–Ω–µ—Ü–æ–≤ –ö.–ö.,+7 900 000-00-04',
    '–û–û–û "–ì–∏–¥—Ä–æ–ú–æ–Ω—Ç–∞–∂",7733333333,0818500000825005005,223-–§–ó,contact@hydro.ru,–°–º–∏—Ä–Ω–æ–≤ –°.–°.,+7 900 000-00-05',
    '–û–û–û "–°—Ç—Ä–æ–π–ö—Ä–∞—Ñ—Ç",7734567890,0818500000825006006,44-–§–ó,info@stroikraft.ru,–ò–≤–∞–Ω–æ–≤ –ò.–ò.,+7 900 000-00-01'
  ].join('\n');
  Papa.parse(demo,{header:false,skipEmptyLines:"greedy",complete:(r)=>{
    const rows = toRows(r);
    store.rows=rows; store.model=trainModel(rows); store.version='demo-1';
    saveLocal(); updateModelInfo(); log('–î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.', 'ok');
  }});
};
$('#train').onclick=()=>{
  if(!store.rows.length){ log('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ CSV –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç.', 'err'); return; }
  store.model=trainModel(store.rows); store.version='retrain-'+Date.now();
  saveLocal(); updateModelInfo(); log('–ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.', 'ok');
};
$('#clear').onclick=()=>{
  store.rows=[]; store.model=null; store.version=null; localStorage.removeItem(LS_KEY);
  updateModelInfo(); log('–ò—Å—Ç–æ—Ä–∏—è –∏ –º–æ–¥–µ–ª—å –æ—á–∏—â–µ–Ω—ã.', 'ok');
};

/* ===== Export / Import JSON ===== */
function downloadJSON(name, data){
  const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click();
  URL.revokeObjectURL(url); a.remove();
}
$('#exportBtn').onclick=()=>{
  if(!store.model || !store.rows.length){ log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.', 'err'); return; }
  downloadJSON('bg-model.json', {rows:store.rows, model:store.model, version:store.version});
  log('–§–∞–π–ª bg-model.json —Å–∫–∞—á–∞–Ω.', 'ok');
};
$('#importFile').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const data=JSON.parse(await f.text());
    if(!Array.isArray(data.rows)||!data.model){ log('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON.', 'err'); return; }
    store.rows=data.rows; store.model=data.model; store.version=data.version||'import';
    saveLocal(); updateModelInfo(); log('–ò–º–ø–æ—Ä—Ç JSON –≤—ã–ø–æ–ª–Ω–µ–Ω.', 'ok');
  }catch(err){ log('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ JSON: '+(err?.message||err), 'err'); }
});

/* ===== Analyze / Browse ===== */
$('#analyze').onclick=()=>{
  const url=$('#tenderUrl').value.trim();
  if(!url){ log('–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∑–∞–∫—É–ø–∫—É.', 'err'); return; }
  if(!store.model || !store.rows.length){ log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é.', 'err'); return; }
  const reg=extractRegNumber(url) || '‚Äî';
  const law=guessLawFromUrl(url);

  const items=Object.entries(store.model.bySupplier).map(([company,m])=>{
    const winsLaw = law ? (store.model.byLawSupplier[(law+'|'+company)]||0) : 0;
    const score = law ? (winsLaw*2 + m.wins*0.5) : m.wins;
    return {company,inn:m.inn||'‚Äî',email:m.email||'‚Äî',dmr:m.dmr||'‚Äî',phone:m.phone||'‚Äî',wins:m.wins,winsLaw,score};
  }).sort((a,b)=>b.score-a.score).slice(0,5);

  const out=$('#outPredict'); out.innerHTML='';
  const head=document.createElement('div'); head.className='item';
  head.innerHTML=`<b>–ó–∞–∫—É–ø–∫–∞:</b> ${escapeHTML(reg)}<br><span class="muted">–ó–∞–∫–æ–Ω (—É–≥–∞–¥–∞–Ω): <b>${escapeHTML(law||'‚Äî')}</b>. –ò—Å—Ç–æ—á–Ω–∏–∫ ‚Äî —á–∞—Å—Ç–æ—Ç—ã –ø–æ–±–µ–¥.</span>`;
  out.appendChild(head);

  if(!items.length){ out.innerHTML+='<div class="item muted">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞.</div>'; return; }

  items.forEach((it,i)=>{
    const tag = i===0 ? `<span class="chip" style="border-color:rgba(102,224,163,.5)">–ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è</span>` : '';
    const why = law ? `–ü–æ–±–µ–¥ –≤ ${it.winsLaw ? law : law}: ${it.winsLaw}, –≤—Å–µ–≥–æ: ${it.wins}` : `–í—Å–µ–≥–æ –ø–æ–±–µ–¥: ${it.wins}`;
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<b>${i+1}. ${escapeHTML(it.company)}</b> (–ò–ù–ù: ${escapeHTML(it.inn)}) ${tag}<br>
                   <span class="muted">${escapeHTML(why)}</span><br>
                   <span class="hint">–ö–æ–Ω—Ç–∞–∫—Ç—ã: ${escapeHTML(it.email)} ¬∑ ${escapeHTML(it.dmr)} ¬∑ ${escapeHTML(it.phone)}</span>`;
    out.appendChild(div);
  });
};
$('#clearPred').onclick=()=>{ $('#tenderUrl').value=''; $('#outPredict').innerHTML=''; };

$('#browseBtn').onclick=()=>{
  if(!store.rows.length){ log('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ CSV.', 'err'); return; }
  const fltReg=$('#fltReg').value.trim().toLowerCase();
  const fltLaw=$('#fltLaw').value.trim().toUpperCase();
  let data=store.rows.slice();
  if(fltReg) data=data.filter(r=>(r.reg_number||'').toLowerCase().includes(fltReg));
  if(fltLaw) data=data.filter(r=>(r.law||'').toUpperCase().includes(fltLaw));
  const out=$('#outBrowse'); out.innerHTML='';
  if(!data.length){ out.innerHTML='<div class="item muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥ —Ñ–∏–ª—å—Ç—Ä—ã.</div>'; return; }
  data.slice(0,200).forEach((r,i)=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<b>${i+1}. –ó–∞–∫—É–ø–∫–∞ ${escapeHTML(r.reg_number||'‚Äî')} (${escapeHTML((r.law||'').toUpperCase()||'‚Äî')})</b><br>
                   –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: <b>${escapeHTML(r.company||'‚Äî')}</b> (–ò–ù–ù: ${escapeHTML(r.inn||'‚Äî')})<br>
                   <span class="hint">–ö–æ–Ω—Ç–∞–∫—Ç—ã: ${escapeHTML(r.winner_email||'‚Äî')} ¬∑ ${escapeHTML(r.dmr_name||'‚Äî')} ¬∑ ${escapeHTML(r.dmr_phone||'‚Äî')}</span>`;
    out.appendChild(div);
  });
};
$('#clearBrowse').onclick=()=>{ $('#fltReg').value=''; $('#fltLaw').value=''; $('#outBrowse').innerHTML=''; };
</script>
</body>
</html>