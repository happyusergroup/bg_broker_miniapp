<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>BG Broker — мини-аппа</title>
<link rel="icon" href="data:,">
<meta name="theme-color" content="#0b0f17"/>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --bg: #0b0f17;
    --bg2: #0e1320;
    --card: rgba(255,255,255,.06);
    --stroke: rgba(255,255,255,.10);
    --text: #eef1f7;
    --muted:#97a0b6;
    --accent:#66e0a3;
    --accent-2:#6ea8ff;
    --danger:#ff6b6b;
    --radius:18px; --r2:12px;
    --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    --pad:16px;
    --w:980px;
    /* ключ: фон берём из темы Telegram (fallback — наш тёмный) */
    --tg-bg: var(--tg-theme-bg-color, #0b0f17);
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg: #eef2f7; --bg2:#e9eef6;
      --card:#ffffff;
      --stroke:#e4e8f0;
      --text:#0c1324;
      --muted:#5f6b86;
      --accent:#14a86c;
      --accent-2:#2d6bff;
      --shadow: 0 12px 24px rgba(10,30,60,.08);
      --tg-bg: var(--tg-theme-bg-color, #eef2f7);
    }
  }

  /* edge-to-edge */
  html{height:100%; background: var(--tg-bg);}
  body{
    margin:0; color:var(--text);
    background: var(--tg-bg);                /* однотонный слой под шапкой Telegram */
    background-attachment: fixed;
    min-height: 100dvh;
    padding-top: max(env(safe-area-inset-top), 0px);
    padding-bottom: max(env(safe-area-inset-bottom), 0px);
    font: 15px/1.55 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    letter-spacing:.1px;
  }
  /* наш красивый градиент — второй слой, начинается сразу под шапкой */
  body::before{
    content:""; position:fixed; inset: calc(env(safe-area-inset-top) + 0px) 0 0 0;
    pointer-events:none; z-index:-1;
    background:
      radial-gradient(1200px 800px at 10% -10%, #1d2540 0%, transparent 60%),
      radial-gradient(1000px 700px at 110% 0%, #163240 0%, transparent 55%),
      linear-gradient(180deg,var(--bg2),var(--bg));
  }

  .wrap{max-width:var(--w); margin:0 auto; padding:18px clamp(14px,3vw,22px)}
  header{
    position:sticky; top:0; z-index:3;
    backdrop-filter:saturate(140%) blur(10px);
    background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02));
    border-bottom:1px solid var(--stroke);
  }
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:34px;height:34px;border-radius:10px;
        background: radial-gradient(120% 120% at 20% 20%, var(--accent) 0%, var(--accent-2) 90%);
        box-shadow: 0 8px 16px rgba(100,200,255,.18);}
  h1{margin:0;font-size:18px}
  .sub{color:var(--muted);font-size:13px;margin-top:2px}
  .tabs{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap}
  .tab{
    border:1px solid var(--stroke); border-radius:12px; padding:10px 14px;
    background:var(--card); cursor:pointer; user-select:none;
    box-shadow:var(--shadow); transition:transform .12s ease, background .2s ease;
  }
  .tab:hover{transform:translateY(-1px)}
  .tab.active{background:linear-gradient(180deg,rgba(102,224,163,.18),rgba(102,224,163,.10)); border-color:rgba(102,224,163,.45)}
  main{padding:18px 0 30px}
  .grid{display:grid; gap:16px}
  .card{
    background:var(--card);
    border:1px solid var(--stroke);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:18px;
  }
  label{display:block; margin:12px 0 6px; font-weight:700}
  input,textarea,select{
    width:100%; background:linear-gradient(0deg, rgba(255,255,255,.06), rgba(255,255,255,.1));
    border:1px solid var(--stroke);
    border-radius:12px; padding:12px 14px; color:var(--text);
    outline:none; box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
  }
  textarea{min-height:120px; resize:vertical}
  input::placeholder, textarea::placeholder{color:var(--muted)}
  .row{display:grid; gap:12px; grid-template-columns:1fr}
  @media (min-width: 820px){ .row{grid-template-columns:1fr 1fr} }

  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:12px 16px; border-radius:12px; border:0; cursor:pointer; font-weight:800;
    color:#07130b; background:linear-gradient(180deg,var(--accent),#3dd98f);
    box-shadow:0 12px 20px rgba(40,180,120,.25);
    transition: transform .12s ease, filter .15s ease;
    min-height:44px;
  }
  .btn:hover{transform:translateY(-1px)}
  .btn.secondary{background:linear-gradient(180deg,var(--accent-2),#3f7dff); color:#06112c; box-shadow:0 12px 20px rgba(70,120,255,.25)}
  .btn.ghost{background:transparent; color:var(--text); border:1px dashed var(--stroke)}
  .btn.danger{background:linear-gradient(180deg,#ff8787,#ff6b6b); color:#1a0c0c; box-shadow:0 12px 20px rgba(255,90,90,.25)}
  .muted{color:var(--muted)}
  .list .item{padding:12px;border:1px dashed var(--stroke);border-radius:12px;background:rgba(255,255,255,.04);margin:8px 0}
  .hint{font-size:12px;color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.05)}
  .drop{
    border:2px dashed var(--stroke); border-radius:14px; padding:18px; text-align:center; color:var(--muted);
    transition:border-color .2s ease, background .2s ease;
  }
  .drop.drag{border-color:var(--accent); background:rgba(102,224,163,.08)}
  footer{margin:26px 0 12px;text-align:center;color:#9aa3b9;font-size:12px}

  /* Modal */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50;
         backdrop-filter: blur(6px) saturate(140%); background:rgba(0,0,0,.35)}
  .modal .box{width:min(92vw,420px); background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:18px; box-shadow:var(--shadow)}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>BG Broker — мини-аппа</h1>
          <div class="sub">Вставьте ссылку → прогноз участников/победителя. Историю загружаем во вкладке «Админ».</div>
        </div>
      </div>
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="predict" role="tab" aria-selected="true">Закупка</div>
        <div class="tab" data-tab="browse" role="tab" aria-selected="false">Все закупки</div>
        <div class="tab" data-tab="admin" role="tab" aria-selected="false">Админ</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- Закупка -->
      <section id="predict" class="card" role="tabpanel">
        <label>Ссылка на закупку (ЕИС 44-ФЗ / 223-ФЗ)</label>
        <input id="tenderUrl" placeholder="https://zakupki.gov.ru/..." inputmode="url"/>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <button class="btn" id="analyze">Анализ</button>
          <button class="btn ghost" id="clearPred">Очистить</button>
          <div class="hint">Контекст из ЕИС подключим позже. Сейчас используется рейтинг по историческим победам.</div>
        </div>
        <div id="outPredict" class="list" style="margin-top:12px" aria-live="polite"></div>
      </section>

      <!-- Все закупки -->
      <section id="browse" class="card" style="display:none" role="tabpanel">
        <div class="row">
          <div>
            <label>Фильтр по рег. номеру</label>
            <input id="fltReg" placeholder="Напр.: 0818500000825..."/>
          </div>
          <div>
            <label>Фильтр по закону</label>
            <input id="fltLaw" placeholder="44-ФЗ или 223-ФЗ"/>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn secondary" id="browseBtn">Показать закупки</button>
          <button class="btn ghost" id="clearBrowse">Сбросить фильтры</button>
        </div>
        <div class="hint" style="margin-top:8px">Источник — загруженный CSV (7 колонок). Для каждой компании выводим ИНН, почту и ЛПР.</div>
        <div id="outBrowse" class="list" style="margin-top:12px" aria-live="polite"></div>
      </section>

      <!-- Админ -->
      <section id="admin" class="card" style="display:none" role="tabpanel">
        <h3 style="margin:0 0 6px">Загрузка истории и обучение</h3>

        <div class="row">
          <div>
            <label>Загрузить историю (CSV, 7 колонок по порядку)</label>
            <input type="file" id="csv" accept=".csv,text/csv"/>
            <div class="drop" id="drop">или перетащите CSV сюда</div>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" id="loadDemo">Загрузить демо-данные</button>
              <button class="btn secondary" id="train">Переобучить</button>
              <button class="btn danger" id="clear">Очистить историю</button>
            </div>
            <label style="margin-top:14px">Вставить CSV текстом (если файл не выбирается на iPhone)</label>
            <textarea id="csvText" placeholder='company,inn,reg_number,law,winner_email,dmr_name,dmr_phone\n...'></textarea>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" id="parseText">Импорт из текста</button>
              <button class="btn ghost" id="clearText">Очистить поле</button>
            </div>
          </div>
          <div>
            <label>Статус модели</label>
            <div id="modelInfo" class="list">
              <div class="item">Исторических записей: 0<br/>Версия модели: —</div>
            </div>

            <label style="margin-top:12px">Перенос между устройствами (без облака)</label>
            <div class="chips" style="margin-bottom:8px">
              <div class="chip">Экспорт JSON → на другое устройство</div>
              <div class="chip">Импорт JSON ← из файла</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" id="exportBtn">Скачать bg-model.json</button>
              <input type="file" id="importFile" accept=".json" style="max-width:260px"/>
            </div>

            <label style="margin-top:14px">Логи</label>
            <div id="logs" class="list" style="min-height:80px">
              <div class="item muted">Здесь будут появляться сообщения об ошибках и статусе.</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    BG Broker · быстрый ориентировочный прогноз. Для финального решения — экспертиза банка и ЕИС API.
  </footer>

  <!-- Пароль на «Админ» -->
  <div id="pwdModal" class="modal" aria-hidden="true">
    <div class="box">
      <h3 style="margin:0 0 6px">Доступ к разделу «Админ»</h3>
      <div class="muted" style="margin-bottom:8px">Введите пароль (подсказка: <b>admin</b>)</div>
      <input id="pwdInput" type="password" placeholder="Пароль"/>
      <label style="margin-top:8px"><input type="checkbox" id="pwdRemember"> Запомнить на этом устройстве</label>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="pwdOk">Войти</button>
        <button class="btn ghost" id="pwdCancel">Отмена</button>
      </div>
    </div>
  </div>

<script>
/* Telegram edge-to-edge */
try {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
  Telegram.WebApp.setHeaderColor('bg_color');
  Telegram.WebApp.setBackgroundColor('bg_color');

  const applyTheme = () => {
    const bg = getComputedStyle(document.documentElement)
                 .getPropertyValue('--tg-theme-bg-color') || '#0b0f17';
    let m = document.querySelector('meta[name="theme-color"]');
    if(!m){ m = document.createElement('meta'); m.name='theme-color'; document.head.appendChild(m); }
    m.content = bg.trim();
    document.documentElement.style.background = bg.trim();
  };
  Telegram.WebApp.onEvent('themeChanged', applyTheme);
  applyTheme();
} catch(e) {}

/* ===== Helpers ===== */
const IS_IOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const LS_KEY='bg_miniapp_store_v1', LS_ADMIN='bg_admin_persist', SS_ADMIN='bg_admin_unlocked';
const $ = (s)=>document.querySelector(s);
const log = (msg, type='info')=>{
  const box = $('#logs');
  const div = document.createElement('div');
  div.className = 'item';
  if(type==='err') div.style.borderColor = 'rgba(255,107,107,.5)';
  if(type==='ok')  div.style.borderColor = 'rgba(102,224,163,.5)';
  div.innerHTML = msg;
  box.prepend(div);
};

const store = { rows: [], model:null, version:null };

function clean(s){ return (s??'').toString().replace(/\u00A0/g,' ').replace(/\s+/g,' ').replace(/\uFFFD/g,'').trim() }
function escapeHTML(s){return clean(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]))}
function extractRegNumber(url){ try{ const u=new URL(url); return u.searchParams.get('regNumber')||'' }catch{ return '' } }
function guessLawFromUrl(url){ const s=url.toLowerCase(); if(s.includes('44-фз')||s.includes('44fz'))return'44-ФЗ'; if(s.includes('223-фз')||s.includes('223fz'))return'223-ФЗ'; return '' }

function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify({rows:store.rows, model:store.model, version:store.version})) }
function loadLocal(){
  try{
    const raw=localStorage.getItem(LS_KEY); if(!raw) return false;
    const dat=JSON.parse(raw);
    if(Array.isArray(dat.rows)){ store.rows=dat.rows; store.model=dat.model||null; store.version=dat.version||null; return true; }
  }catch{}
  return false;
}

function toRows(res){
  const rows=[];
  for(const r of res.data){
    if(!r || !r.length) continue;
    while(r.length<7) r.push('');
    const rec={
      company:clean(r[0]), inn:clean(r[1]), reg_number:clean(r[2]),
      law:clean(r[3]).toUpperCase(), winner_email:clean(r[4]),
      dmr_name:clean(r[5]), dmr_phone:clean(r[6]),
    };
    const headerHints=["company","inn","reg_number","law","winner_email","dmr_name","dmr_phone"];
    const maybeHeader=headerHints.some(h=>rec.company.toLowerCase().includes(h)||rec.inn.toLowerCase().includes(h));
    if(maybeHeader) continue;
    if(!rec.company) continue;
    rows.push(rec);
  }
  return rows;
}

function trainModel(rows){
  const bySupplier={}, byLawSupplier={};
  rows.forEach(r=>{
    const c=r.company; if(!c) return;
    bySupplier[c]=bySupplier[c]||{wins:0, inn:r.inn, email:r.winner_email, dmr:r.dmr_name, phone:r.dmr_phone};
    bySupplier[c].wins++;
    if(r.law){ const key=r.law+'|'+c; byLawSupplier[key]=(byLawSupplier[key]||0)+1; }
  });
  return {bySupplier, byLawSupplier};
}
function updateModelInfo(){
  $('#modelInfo').innerHTML=`<div class="item">Исторических записей: <b>${store.rows.length}</b><br>Версия модели: <b>${store.version||'—'}</b></div>`;
}

/* ===== Bootstrap ===== */
(function(){
  if(loadLocal()){ updateModelInfo(); log('Локальная модель загружена', 'ok'); }
  if(localStorage.getItem(LS_ADMIN)==='1'){ sessionStorage.setItem(SS_ADMIN,'1'); }
})();

/* ===== Admin auth ===== */
const modal=$('#pwdModal'), pwd=$('#pwdInput'), remember=$('#pwdRemember');
function openPwd(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); setTimeout(()=>pwd.focus(),50) }
function closePwd(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true') }
$('#pwdCancel').onclick=closePwd;
$('#pwdOk').onclick=()=>{
  if(pwd.value==='admin'){
    sessionStorage.setItem(SS_ADMIN,'1');
    if(remember.checked) localStorage.setItem(LS_ADMIN,'1'); else localStorage.removeItem(LS_ADMIN);
    closePwd(); switchTab('admin');
  } else { log('Неверный пароль', 'err'); }
}
pwd.addEventListener('keydown',e=>{ if(e.key==='Enter') $('#pwdOk').click() });

/* ===== Tabs ===== */
function switchTab(id){
  document.querySelectorAll('.tab').forEach(t=>{
    t.classList.toggle('active', t.dataset.tab===id);
    t.setAttribute('aria-selected', t.dataset.tab===id ? 'true':'false');
  });
  ['predict','browse','admin'].forEach(sec=>{
    document.getElementById(sec).style.display=(sec===id)?'block':'none';
  });
}
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    const id=t.dataset.tab;
    if(id==='admin' && !sessionStorage.getItem(SS_ADMIN)) { openPwd(); return; }
    switchTab(id);
  }
});

/* ===== CSV import — безопасно для iPhone ===== */
async function parseCsvText(text,{useWorker=true}={}){
  return new Promise((resolve,reject)=>{
    Papa.parse(text,{ header:false, skipEmptyLines:"greedy", worker: useWorker,
      complete: r=>resolve(toRows(r)), error: e=>reject(e) });
  });
}
$('#csv').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const text = await f.text();
    const rows = await parseCsvText(text,{useWorker:!IS_IOS});
    if(!rows.length){ log('CSV разобран, но записей нет. Сохраните как «CSV UTF-8».', 'err'); return; }
    store.rows = rows; store.model = trainModel(rows); store.version='csv-'+Date.now();
    saveLocal(); updateModelInfo(); log(`CSV загружен: ${rows.length} записей.`, 'ok');
  }catch(err){ log('Ошибка загрузки CSV: '+(err?.message||err), 'err'); }
});
$('#parseText').onclick = async ()=>{
  const text = $('#csvText').value.trim();
  if(!text){ log('Поле с CSV пустое.', 'err'); return; }
  try{
    const rows = await parseCsvText(text,{useWorker:false});
    if(!rows.length){ log('Текст распознан, но записей нет. Проверьте разделители.', 'err'); return; }
    store.rows = rows; store.model = trainModel(rows); store.version='text-'+Date.now();
    saveLocal(); updateModelInfo(); log(`Импорт из текста: ${rows.length} записей.`, 'ok');
  }catch(err){ log('Ошибка парсинга текста: '+(err?.message||err), 'err'); }
};
$('#clearText').onclick = ()=> $('#csvText').value = '';

/* Drag & drop (desktop) */
const drop=$('#drop');
['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag') }));
['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag') }));
drop.addEventListener('drop', async e=>{
  const file = e.dataTransfer.files?.[0]; if(!file) return;
  $('#csv').files = e.dataTransfer.files;
  try{
    const text = await file.text();
    const rows = await parseCsvText(text,{useWorker:true});
    if(!rows.length){ log('CSV распознан, но записей нет.', 'err'); return; }
    store.rows = rows; store.model = trainModel(rows); store.version='csv-'+Date.now();
    saveLocal(); updateModelInfo(); log(`CSV загружен (dnd): ${rows.length} записей.`, 'ok');
  }catch(err){ log('Ошибка dnd: '+(err?.message||err), 'err'); }
});

/* ===== Demo, retrain, clear ===== */
$('#loadDemo').onclick=()=>{
  const demo=[
    'ООО "СтройКрафт",7734567890,0818500000825001001,44-ФЗ,info@stroikraft.ru,Иванов И.И.,+7 900 000-00-01',
    'ООО "ТеплоСервис",7711111111,0818500000825002002,44-ФЗ,hello@teplo.ru,Петров П.П.,+7 900 000-00-02',
    'ООО "ИнжСтрой",7722222222,0818500000825003003,223-ФЗ,mail@inz.ru,Сидоров С.С.,+7 900 000-00-03',
    'ООО "ЭнергоПроект",7700000000,0818500000825004004,44-ФЗ,office@energo.pro,Кузнецов К.К.,+7 900 000-00-04',
    'ООО "ГидроМонтаж",7733333333,0818500000825005005,223-ФЗ,contact@hydro.ru,Смирнов С.С.,+7 900 000-00-05',
    'ООО "СтройКрафт",7734567890,0818500000825006006,44-ФЗ,info@stroikraft.ru,Иванов И.И.,+7 900 000-00-01'
  ].join('\n');
  Papa.parse(demo,{header:false,skipEmptyLines:"greedy",complete:(r)=>{
    const rows = toRows(r);
    store.rows=rows; store.model=trainModel(rows); store.version='demo-1';
    saveLocal(); updateModelInfo(); log('Демо-данные загружены.', 'ok');
  }});
};
$('#train').onclick=()=>{
  if(!store.rows.length){ log('Сначала загрузите CSV или вставьте текст.', 'err'); return; }
  store.model=trainModel(store.rows); store.version='retrain-'+Date.now();
  saveLocal(); updateModelInfo(); log('Переобучение завершено.', 'ok');
};
$('#clear').onclick=()=>{
  store.rows=[]; store.model=null; store.version=null; localStorage.removeItem(LS_KEY);
  updateModelInfo(); log('История и модель очищены.', 'ok');
};

/* ===== Export / Import JSON ===== */
function downloadJSON(name, data){
  const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click();
  URL.revokeObjectURL(url); a.remove();
}
$('#exportBtn').onclick=()=>{
  if(!store.model || !store.rows.length){ log('Нет данных для экспорта.', 'err'); return; }
  downloadJSON('bg-model.json', {rows:store.rows, model:store.model, version:store.version});
  log('Файл bg-model.json скачан.', 'ok');
};
$('#importFile').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const data=JSON.parse(await f.text());
    if(!Array.isArray(data.rows)||!data.model){ log('Неверный формат JSON.', 'err'); return; }
    store.rows=data.rows; store.model=data.model; store.version=data.version||'import';
    saveLocal(); updateModelInfo(); log('Импорт JSON выполнен.', 'ok');
  }catch(err){ log('Ошибка импорта JSON: '+(err?.message||err), 'err'); }
});

/* ===== Analyze ===== */
$('#analyze').onclick=()=>{
  const url=$('#tenderUrl').value.trim();
  if(!url){ log('Вставьте ссылку на закупку.', 'err'); return; }
  if(!store.model || !store.rows.length){ log('Нет данных для прогноза. Загрузите историю.', 'err'); return; }
  const reg=extractRegNumber(url) || '—';
  const law=guessLawFromUrl(url);

  const items=Object.entries(store.model.bySupplier).map(([company,m])=>{
    const winsLaw = law ? (store.model.byLawSupplier[(law+'|'+company)]||0) : 0;
    const score = law ? (winsLaw*2 + m.wins*0.5) : m.wins;
    return {company,inn:m.inn||'—',email:m.email||'—',dmr:m.dmr||'—',phone:m.phone||'—',wins:m.wins,winsLaw,score};
  }).sort((a,b)=>b.score-a.score).slice(0,5);

  const out=$('#outPredict'); out.innerHTML='';
  const head=document.createElement('div'); head.className='item';
  head.innerHTML=`<b>Закупка:</b> ${escapeHTML(reg)}<br><span class="muted">Закон (угадан): <b>${escapeHTML(law||'—')}</b>. Источник — частоты побед.</span>`;
  out.appendChild(head);

  if(!items.length){ out.innerHTML+='<div class="item muted">Недостаточно данных для прогноза.</div>'; return; }

  items.forEach((it,i)=>{
    const tag = i===0 ? `<span class="chip" style="border-color:rgba(102,224,163,.5)">прогноз победителя</span>` : '';
    const why = law ? `Побед в ${law}: ${it.winsLaw}, всего: ${it.wins}` : `Всего побед: ${it.wins}`;
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<b>${i+1}. ${escapeHTML(it.company)}</b> (ИНН: ${escapeHTML(it.inn)}) ${tag}<br>
                   <span class="muted">${escapeHTML(why)}</span><br>
                   <span class="hint">Контакты: ${escapeHTML(it.email)} · ${escapeHTML(it.dmr)} · ${escapeHTML(it.phone)}</span>`;
    out.appendChild(div);
  });
};
$('#clearPred').onclick=()=>{ $('#tenderUrl').value=''; $('#outPredict').innerHTML=''; };

/* ===== Browse ===== */
$('#browseBtn').onclick=()=>{
  if(!store.rows.length){ log('Сначала загрузите CSV.', 'err'); return; }
  const fltReg=$('#fltReg').value.trim().toLowerCase();
  const fltLaw=$('#fltLaw').value.trim().toUpperCase();
  let data=store.rows.slice();
  if(fltReg) data=data.filter(r=>(r.reg_number||'').toLowerCase().includes(fltReg));
  if(fltLaw) data=data.filter(r=>(r.law||'').toUpperCase().includes(fltLaw));
  const out=$('#outBrowse'); out.innerHTML='';
  if(!data.length){ out.innerHTML='<div class="item muted">Ничего не найдено под фильтры.</div>'; return; }
  data.slice(0,200).forEach((r,i)=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<b>${i+1}. Закупка ${escapeHTML(r.reg_number||'—')} (${escapeHTML((r.law||'').toUpperCase()||'—')})</b><br>
                   Победитель: <b>${escapeHTML(r.company||'—')}</b> (ИНН: ${escapeHTML(r.inn||'—')})<br>
                   <span class="hint">Контакты: ${escapeHTML(r.winner_email||'—')} · ${escapeHTML(r.dmr_name||'—')} · ${escapeHTML(r.dmr_phone||'—')}</span>`;
    out.appendChild(div);
  });
};
$('#clearBrowse').onclick=()=>{ $('#fltReg').value=''; $('#fltLaw').value=''; $('#outBrowse').innerHTML=''; };
</script>
</body>
</html>