<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>BG Broker — Mini App (CSV v2)</title>
<link rel="icon" href="data:,">
<!-- Telegram Mini App SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<!-- Надёжный CSV-парсер -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --bg:#0f1115; --card:#151923; --text:#e8eaf0; --muted:#9aa3b2; --accent:#3ecf8e;
    --border:#202636; --input:#0f1320; --radius:14px; --radius-sm:10px;
    --s1:6px; --s2:10px; --s3:14px; --s4:18px; --s5:24px;
    --fs-12:12px; --fs-13:13px; --fs-14:14px; --fs-15:15px; --fs-16:16px; --fs-18:18px; --fs-20:20px;
    --container:960px;
  }
  @media (min-width: 768px){ :root{ --fs-15:16px; --fs-18:20px; --fs-20:22px; } }
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font: var(--fs-15)/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    padding-bottom: env(safe-area-inset-bottom);
  }
  .wrap{max-width:var(--container);margin:0 auto;padding:0 var(--s3)}
  header{padding:calc(var(--s3) + env(safe-area-inset-top)) var(--s3) var(--s3);border-bottom:1px solid var(--border)}
  h1{margin:0 0 var(--s1);font-size:var(--fs-18);color:var(--accent)}
  .muted{color:var(--muted);font-size:var(--fs-13)}

  .tabs{display:flex;gap:var(--s1);margin:var(--s2) 0;flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);background:#1a2030;cursor:pointer;user-select:none}
  .tab.active{background:var(--accent);color:#08120e;border-color:transparent}

  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:var(--s3);margin:var(--s2) 0}
  label{display:block;margin:var(--s2) 0 var(--s1);font-weight:600}
  input,button{font:inherit}
  input{
    width:100%;padding:12px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--input);color:var(--text)
  }
  input::placeholder{color:#7f8797}
  .btn{display:inline-block;background:var(--accent);color:#08120e;border:0;border-radius:var(--radius-sm);padding:12px 16px;font-weight:700;cursor:pointer;min-width:44px;min-height:44px}
  .btn:active{transform:translateY(1px)}
  .note{font-size:var(--fs-12);color:var(--muted)}

  .list .item{padding:12px;border:1px solid var(--border);border-radius:var(--radius-sm);margin:var(--s1) 0;background:var(--input)}
  .good{color:#3ecf8e}

  .row{display:grid;grid-template-columns:1fr;gap:var(--s2)}
  @media (min-width:768px){ .row{grid-template-columns:1fr 1fr} }
  @media (max-width:480px){ h1{font-size:var(--fs-16)} .btn{width:100%} }

  @media (prefers-color-scheme: light){
    :root{ --bg:#f7f8fb; --card:#ffffff; --text:#0c0d10; --muted:#5f6674; --border:#e6e8ee; --input:#ffffff; }
    .tab{background:#f1f3f8}.tab.active{color:#ffffff} input{background:#fff}
  }
</style>
</head>
<body>
<header class="wrap">
  <h1>BG Broker — мини-аппа</h1>
  <div class="muted">Вставьте ссылку на закупку → прогноз участников/победителя. История загружается во вкладке «Админ».</div>
</header>

<main class="wrap" style="padding-bottom:calc(var(--s4) + env(safe-area-inset-bottom))">
  <div class="tabs" role="tablist" aria-label="Навигация">
    <button class="tab active" data-tab="predict" role="tab" aria-selected="true">Закупка</button>
    <button class="tab" data-tab="browse" role="tab" aria-selected="false">Все закупки</button>
    <button class="tab" data-tab="admin" role="tab" aria-selected="false">Админ</button>
  </div>

  <!-- ВКЛАДКА 1: ЗАКУПКА -->
  <section class="card" id="predict" role="tabpanel">
    <label>Ссылка на закупку (ЕИС 44-ФЗ / 223-ФЗ)</label>
    <input id="tenderUrl" placeholder="https://zakupki.gov.ru/..." inputmode="url" />
    <div style="margin-top:var(--s2);display:flex;gap:var(--s2);flex-wrap:wrap">
      <button class="btn" id="analyze">Анализ</button>
      <span class="note">Контекст подтянем из ЕИС API позже; сейчас — частоты побед по закону и общий рейтинг.</span>
    </div>
    <div id="outPredict" class="list" aria-live="polite" style="margin-top:var(--s2)"></div>
  </section>

  <!-- ВКЛАДКА 2: ВСЕ ЗАКУПКИ -->
  <section class="card" id="browse" style="display:none" role="tabpanel">
    <div class="row">
      <div>
        <label>Фильтр по рег. номеру</label>
        <input id="fltReg" placeholder="Напр.: 0818500000825..." />
      </div>
      <div>
        <label>Фильтр по закону</label>
        <input id="fltLaw" placeholder="44-ФЗ или 223-ФЗ" />
      </div>
    </div>
    <button class="btn" id="browseBtn" style="margin-top:var(--s2)">Показать закупки с победителями</button>
    <div class="note" style="margin-top:var(--s1)">Источник — загруженный CSV (7 колонок). У каждой компании выводим ИНН, почту, ФИО и телефон ЛПРа.</div>
    <div id="outBrowse" class="list" aria-live="polite" style="margin-top:var(--s2)"></div>
  </section>

  <!-- ВКЛАДКА 3: АДМИН -->
  <section class="card" id="admin" style="display:none" role="tabpanel">
    <h3 style="margin-top:0">Загрузка истории и обучение ИИ</h3>
    <div class="row">
      <div>
        <label>Загрузить историю (CSV, 7 колонок по порядку)</label>
        <input type="file" id="csv" accept=".csv" />
        <div class="note">
          1) company · 2) inn · 3) reg_number · 4) law · 5) winner_email · 6) dmr_name · 7) dmr_phone
        </div>
      </div>
      <div>
        <label>Статус модели</label>
        <div id="modelInfo" class="list"><div class="item">Исторических записей: 0<br>Версия модели: —</div></div>
      </div>
    </div>
    <div style="margin-top:var(--s2);display:flex;gap:var(--s2);flex-wrap:wrap">
      <button class="btn" id="loadDemo">Загрузить демо-данные</button>
      <button class="btn" id="train">Переобучить</button>
      <button class="btn" id="clear">Очистить историю</button>
    </div>
    <div class="note" style="margin-top:var(--s2)">
      ЕИС API подключим позже (нужен токен). Модель уже обучается на CSV и учитывает частоты побед по 44/223-ФЗ.
    </div>
  </section>
</main>

<script>
/* Telegram init */
try{ Telegram.WebApp.ready(); Telegram.WebApp.expand(); }catch(e){}

/* ===== Хранилище ===== */
const store = { rows: [], model: null, version: null };

/* ===== Утилиты ===== */
function extractRegNumber(url){
  try{ const u=new URL(url); return u.searchParams.get('regNumber')||'' }catch(e){ return '' }
}
function guessLawFromUrl(url){
  const s = url.toLowerCase();
  if(s.includes('44-фз') || s.includes('44fz') || s.includes('law44')) return '44-ФЗ';
  if(s.includes('223-фз')|| s.includes('223fz')|| s.includes('law223')) return '223-ФЗ';
  return ''; // не смогли угадать
}

/* ===== Парсинг CSV (надёжный) =====
   Принимаем любой разделитель (, ; \t), кавычки, заголовок не обязателен.
   Берём РОВНО первые 7 колонок по порядку и отбрасываем возможную строку-заголовок. */
function parseCSVFlexible(text) {
  const res = Papa.parse(text, {
    delimiter: "",            // авто-детект
    newline: "",              // авто-детект
    quoteChar: '"',
    escapeChar: '"',
    header: false,
    skipEmptyLines: "greedy",
    transform: (val) => (val == null ? "" : String(val).trim())
  });
  if (res.errors && res.errors.length) {
    console.warn("CSV parse errors:", res.errors.slice(0,3));
  }
  const rows = [];
  for (const r of res.data) {
    if (!r || !r.length) continue;
    // гарантируем длину 7
    while (r.length < 7) r.push('');
    const [company, inn, reg_number, law, winner_email, dmr_name, dmr_phone] =
      [0,1,2,3,4,5,6].map(i => (r[i] ?? "").toString().trim());

    // отсечь возможную шапку
    const headerHints = ["company","inn","reg_number","law","winner_email","dmr_name","dmr_phone"];
    const maybeHeader = headerHints.some(h => company.toLowerCase().includes(h) || inn.toLowerCase().includes(h));
    if (maybeHeader) continue;

    if (!company) continue; // обязательное поле
    rows.push({ company, inn, reg_number, law, winner_email, dmr_name, dmr_phone });
  }
  return rows;
}

/* ===== Простейшая «ИИ»-модель (скоринг частотами) =====
   - bySupplier: суммарные победы компании
   - byLawSupplier: победы по конкретному закону (44 / 223) */
function trainModel(rows){
  const bySupplier = {};
  const byLawSupplier = {};
  rows.forEach(r=>{
    const c = r.company||''; if(!c) return;
    const law = (r.law||'').toUpperCase();
    bySupplier[c] = bySupplier[c] || { wins:0, inn:r.inn||'', email:r.winner_email||'', dmr:r.dmr_name||'', phone:r.dmr_phone||'' };
    bySupplier[c].wins++;
    if(law){
      const key = law+'|'+c;
      byLawSupplier[key] = (byLawSupplier[key]||0)+1;
    }
  });
  return { bySupplier, byLawSupplier };
}

/* ===== Админ: загрузка / обучение / очистка ===== */
function updateModelInfo(){
  const n = store.rows.length;
  const v = store.version || '—';
  document.getElementById('modelInfo').innerHTML =
    `<div class="item">Исторических записей: <b>${n}</b><br>Версия модели: <b>${v}</b></div>`;
}

document.getElementById('csv').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const text = await f.text(); // читает UTF-8/BOM
  const parsed = parseCSVFlexible(text);
  if(!parsed.length){
    alert('Не удалось распознать данные. Проверь разделитель (, или ;) и порядок 7 колонок.');
    return;
  }
  store.rows = parsed;
  store.model = trainModel(store.rows);
  store.version = 'csv-'+Date.now();
  updateModelInfo();
  alert('CSV загружен: '+store.rows.length+' записей. Модель обучена.');
});

document.getElementById('loadDemo').onclick = ()=>{
  const demo = [
    'ООО "СтройКрафт",7734567890,0818500000825001001,44-ФЗ,info@stroikraft.ru,Иванов И.И.,+7 900 000-00-01',
    'ООО "ТеплоСервис",7711111111,0818500000825002002,44-ФЗ,hello@teplo.ru,Петров П.П.,+7 900 000-00-02',
    'ООО "ИнжСтрой",7722222222,0818500000825003003,223-ФЗ,mail@inz.ru,Сидоров С.С.,+7 900 000-00-03',
    'ООО "ЭнергоПроект",7700000000,0818500000825004004,44-ФЗ,office@energo.pro,Кузнецов К.К.,+7 900 000-00-04',
    'ООО "ГидроМонтаж",7733333333,0818500000825005005,223-ФЗ,contact@hydro.ru,Смирнов С.С.,+7 900 000-00-05',
    'ООО "СтройКрафт",7734567890,0818500000825006006,44-ФЗ,info@stroikraft.ru,Иванов И.И.,+7 900 000-00-01'
  ].join('\n');
  store.rows = parseCSVFlexible(demo);
  store.model = trainModel(store.rows);
  store.version = 'demo-1';
  updateModelInfo();
  alert('Загружены демо-данные и обучена модель.');
};

document.getElementById('train').onclick = ()=>{
  if(!store.rows.length){ alert('Сначала загрузите CSV.'); return; }
  store.model = trainModel(store.rows);
  store.version = 'retrain-'+Date.now();
  updateModelInfo();
  alert('Переобучение завершено.');
};

document.getElementById('clear').onclick = ()=>{
  store.rows=[]; store.model=null; store.version=null;
  updateModelInfo();
  alert('История и модель очищены.');
};
updateModelInfo();

/* ===== Вкладки ===== */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>{x.classList.remove('active');x.setAttribute('aria-selected','false')});
    t.classList.add('active'); t.setAttribute('aria-selected','true');
    const id=t.dataset.tab;
    ['predict','browse','admin'].forEach(sec=>{
      document.getElementById(sec).style.display = (sec===id)?'block':'none';
    });
  });
});

/* ===== Анализ закупки (прогноз по ссылке) ===== */
document.getElementById('analyze').addEventListener('click', ()=>{
  const url = document.getElementById('tenderUrl').value.trim();
  if(!url){ alert('Вставьте ссылку на закупку.'); return; }
  if(!store.model || !store.rows.length){ alert('Нет данных. Загрузите CSV во вкладке «Админ».'); return; }

  const reg = extractRegNumber(url) || '—';
  const lawGuess = guessLawFromUrl(url); // может быть пусто

  const items = Object.entries(store.model.bySupplier).map(([company,meta])=>{
    const winsLaw = lawGuess ? (store.model.byLawSupplier[(lawGuess.toUpperCase()+'|'+company)]||0) : 0;
    const score = lawGuess ? (winsLaw*2 + meta.wins*0.5) : meta.wins; // закон, если угадан, весим сильнее
    return { company, inn:meta.inn||'—', email:meta.email||'—', dmr:meta.dmr||'—', phone:meta.phone||'—', wins:meta.wins, winsLaw, score };
  }).sort((a,b)=>b.score-a.score).slice(0,5);

  const out = document.getElementById('outPredict'); out.innerHTML='';
  const head = document.createElement('div');
  head.className='item';
  head.innerHTML = `<b>Закупка:</b> ${reg}<br><span class="muted">Закон (угаданный по ссылке): <b>${lawGuess||'—'}</b>. Источник прогноза — частоты побед из загруженной истории.</span>`;
  out.appendChild(head);

  if(!items.length){ out.innerHTML += '<div class="item">Недостаточно данных для прогноза.</div>'; return; }

  items.forEach((it,i)=>{
    const rank = i===0 ? '<b class="good">— прогноз победителя</b>' : '';
    const why  = lawGuess ? `Побед в ${lawGuess}: ${it.winsLaw}, всего побед: ${it.wins}` : `Всего побед: ${it.wins}`;
    const div  = document.createElement('div');
    div.className='item';
    div.innerHTML = `<b>${i+1}. ${it.company}</b> (ИНН: ${it.inn}) ${rank}<br>
      <span class="muted">${why}</span><br>
      <span class="note">Контакты: ${it.email} · ${it.dmr} · ${it.phone}</span>`;
    out.appendChild(div);
  });
});

/* ===== Все закупки (список из CSV) ===== */
document.getElementById('browseBtn').addEventListener('click', ()=>{
  if(!store.rows.length){ alert('Сначала загрузите CSV во вкладке «Админ».'); return; }
  const fltReg = document.getElementById('fltReg').value.trim().toLowerCase();
  const fltLaw = document.getElementById('fltLaw').value.trim().toUpperCase();

  let data = store.rows.slice();
  if(fltReg) data = data.filter(r=> (r.reg_number||'').toLowerCase().includes(fltReg));
  if(fltLaw) data = data.filter(r=> (r.law||'').toUpperCase().includes(fltLaw));

  const out = document.getElementById('outBrowse'); out.innerHTML='';
  if(!data.length){ out.innerHTML = '<div class="item">Ничего не найдено под фильтры.</div>'; return; }

  data.slice(0,150).forEach((r,i)=>{
    const div = document.createElement('div');
    div.className='item';
    div.innerHTML = `<b>${i+1}. Закупка ${r.reg_number||'—'} (${(r.law||'').toUpperCase()||'—'})</b><br>
      Победитель: <b>${r.company||'—'}</b> (ИНН: ${r.inn||'—'})<br>
      <span class="note">Контакты: ${r.winner_email||'—'} · ${r.dmr_name||'—'} · ${r.dmr_phone||'—'}</span>`;
    out.appendChild(div);
  });
});
</script>
</body>
</html>
